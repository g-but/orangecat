name: ðŸ¤– Auto-merge Claude Branches

on:
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge to develop
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/claude/')

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create PR to develop
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          BODY=$(cat <<EOF
          Automated merge from Claude agent branch \
          \
          \`$BRANCH_NAME\` to \`develop\`.

          ## Changes
          This PR was automatically created by the Claude agent workflow.

          **Branch:** \`$BRANCH_NAME\`
          **Commit:** ${{ github.sha }}
          **Triggered by:** ${{ github.actor }}

          ## Review
          Please review the changes and merge when ready.
          EOF
          )

          # Create PR to develop
          gh pr create \
            --title "ðŸ¤– Auto-merge: $BRANCH_NAME" \
            --body "$BODY" \
            --base develop \
            --head "$BRANCH_NAME" \
            || echo "PR may already exist"

      - name: Auto-merge if approved
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # Get PR number
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base develop --json number --jq '.[0].number')

          if [ ! -z "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER"

            # Enable auto-merge
            gh pr merge "$PR_NUMBER" --auto --squash || echo "Auto-merge setup failed (may need approval)"
          fi

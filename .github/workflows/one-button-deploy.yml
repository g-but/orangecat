name: ğŸš€ One-Button Deploy
# This workflow is part of the OrangeCat automated deployment system.
# See docs/deployment/DEPLOYMENT_PROCESS.md for the complete deployment process.
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: false
        type: boolean
      force_deploy:
        description: 'Force deploy (bypass checks)'
        required: false
        default: false
        type: boolean
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    name: ğŸš€ Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ“Š Log Deployment Start
        run: |
          echo "ğŸš€ DEPLOYMENT STARTED"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ·ï¸  Commit: ${{ github.sha }}"
          echo "ğŸ¯ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "âš¡ Trigger: ${{ github.event_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ§¹ Code Quality Check
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          echo "ğŸ§¹ Running code quality checks..."
          npm run lint
          echo "âœ… Code quality check complete"

      - name: âœ… Type Check (tsc)
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          echo "ğŸ” Running TypeScript type-check..."
          npm run type-check
          echo "âœ… Type-check passed"

      - name: ğŸ§ª Run Tests (blocking)
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          echo "ğŸ§ª Running unit tests..."
          npm run test:unit -- --watchAll=false
          echo "âœ… Unit tests complete"

      - name: ğŸ—ï¸ Build Application
        if: ${{ !github.event.inputs.skip_tests }}
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: http://localhost
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: dummy
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy
        run: |
          echo "ğŸ—ï¸ Building application..."
          npm run build
          echo "âœ… Application built successfully"

      - name: ğŸ“± Install Vercel CLI
        run: |
          echo "ğŸ“± Installing Vercel CLI..."
          npm install -g vercel@latest
          echo "âœ… Vercel CLI installed"

      - name: ğŸš€ Deploy to Vercel
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Vercel..."

          if [[ "${{ github.event.inputs.environment }}" == "production" || "${{ github.ref_name }}" == "main" ]]; then
            echo "ğŸŒ Deploying to PRODUCTION"
            DEPLOY_URL=$(vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes)
          else
            echo "ğŸ§ª Deploying to PREVIEW"
            DEPLOY_URL=$(vercel --token=${{ secrets.VERCEL_TOKEN }} --yes)
          fi

          echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment completed: $DEPLOY_URL"

      - name: ğŸ§­ Verify Deployment (Vercel Inspect)
        if: always()
        run: |
          echo "ğŸ§­ Inspecting deployment via Vercel CLI..."
          if [ -n "${{ steps.deploy.outputs.deployment_url }}" ]; then
            vercel inspect "${{ steps.deploy.outputs.deployment_url }}" --token=${{ secrets.VERCEL_TOKEN }} || echo "âš ï¸ Inspect failed (non-blocking)"
          else
            echo "â„¹ï¸ No deployment URL found to inspect"
          fi

      - name: ğŸ” Health Check
        id: health_check
        # Only run health check on production deployments (preview deployments have auth protection)
        if: github.event.inputs.environment == 'production' || github.ref_name == 'main'
        run: |
          echo "ğŸ” Performing health check on production..."
          HEALTH_URL="https://orangecat.ch/api/health"

          # Wait for deployment to be ready
          sleep 30

          for i in {1..10}; do
            echo "Attempt $i: Checking $HEALTH_URL"
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "âœ… Health check passed"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              break
            else
              echo "âš ï¸ Health check failed, retrying in 10s..."
              sleep 10
            fi

            if [ $i -eq 10 ]; then
              echo "âŒ Health check failed after 10 attempts"
              echo "health_status=unhealthy" >> $GITHUB_OUTPUT
              exit 1
            fi
          done

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "================================"
          echo "ğŸ¯ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "ğŸŒ URL: ${{ steps.deploy.outputs.deployment_url }}"
          echo "ğŸ¥ Health: ${{ steps.health_check.outputs.health_status || 'unknown' }}"
          echo "â±ï¸  Duration: ${{ job.duration || 'calculating...' }}"
          echo "ğŸ“… Completed: $(date)"
          echo "âœ… Status: ${{ job.status }}"

      - name: ğŸ”” Notify Success
        if: success()
        run: |
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "ğŸŒ Production URL: https://orangecat.ch"
          echo "ğŸ” Monitor: https://github.com/${{ github.repository }}/actions"
          echo "ğŸ“± Share this success!"

      - name: ğŸš¨ Handle Failure
        if: failure()
        run: |
          echo "ğŸš¨ DEPLOYMENT FAILED!"
          echo "ğŸ“‹ Check the logs above for details"
          echo "ğŸ”§ Common issues:"
          echo "  - Build errors"
          echo "  - Test failures" 
          echo "  - Vercel token issues"
          echo "  - Health check timeout"
          echo "ğŸ†˜ Need help? Check: https://github.com/${{ github.repository }}/actions"

      - name: ğŸŒ Automated Browser Verification
        if: success() && (github.event.inputs.environment == 'production' || github.ref_name == 'main')
        run: |
          echo "ğŸŒ Running automated browser verification..."
          npm run deploy:verify || echo "âš ï¸ Browser verification failed - manual check required"

      - name: ğŸ“ˆ Performance Audit
        if: success() && (github.event.inputs.environment == 'production' || github.ref_name == 'main')
        run: |
          echo "ğŸ“ˆ Running performance audit..."
          npx lighthouse https://orangecat.ch --output=json --chrome-flags="--headless" > lighthouse.json || echo "âš ï¸ Lighthouse audit failed"

          if [ -f lighthouse.json ]; then
            SCORE=$(cat lighthouse.json | jq '.categories.performance.score * 100')
            echo "âš¡ Performance Score: $SCORE/100"
          fi

  monitor:
    name: ğŸ“Š Post-Deploy Monitoring
    needs: deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ” Extended Health Monitoring
        run: |
          echo "ğŸ” Starting extended health monitoring..."

          for i in {1..5}; do
            echo "Monitor check $i/5"
            
            # Check main site
            if curl -f -s "https://orangecat.ch" > /dev/null; then
              echo "âœ… Main site responsive"
            else
              echo "âŒ Main site unresponsive"
            fi
            
            # Check API health
            if curl -f -s "https://orangecat.ch/api/health" > /dev/null; then
              echo "âœ… API healthy"
            else
              echo "âŒ API unhealthy"
            fi
            
            sleep 30
          done

          echo "âœ… Extended monitoring complete"

      - name: ğŸ“Š Final Status Report
        run: |
          echo "ğŸ¯ FINAL DEPLOYMENT STATUS"
          echo "=========================="
          echo "ğŸŒ Production: https://orangecat.ch"
          echo "ğŸ¥ Health API: https://orangecat.ch/api/health"
          echo "ğŸ“Š Monitoring: https://github.com/${{ github.repository }}/actions"
          echo "â° Completed: $(date)"
          echo "ğŸ‰ Deployment verified and monitoring active!"

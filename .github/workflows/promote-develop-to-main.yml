name: ðŸš€ Promote Develop to Main

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_checks:
        description: 'Skip quality checks (emergency deploy)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    name: Create PR to main
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: develop

      - name: Create PR to main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY=$(cat <<EOF
          ## Deployment to Production

          This PR promotes the latest changes from \`develop\` to \`main\` for production deployment.

          ### Changes
          All commits merged to \`develop\` since the last deployment.

          **Triggered by:** ${{ github.actor }}
          **Commit:** ${{ github.sha }}

          ### Post-merge
          - âœ… Vercel will automatically deploy to production
          - âœ… Health checks will run
          - âœ… Performance monitoring will activate

          ## Review Checklist
          - [ ] All features tested in develop
          - [ ] No breaking changes
          - [ ] Database migrations (if any) are ready
          - [ ] Environment variables updated (if needed)

          ---
          *Auto-generated by GitHub Actions*
          EOF
          )

          # Create PR from develop to main
          gh pr create \
            --title "ðŸš€ Promote develop to main" \
            --body "$BODY" \
            --base main \
            --head develop \
            || echo "PR may already exist or no changes to promote"

      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head develop --base main --json number --jq '.[0].number')

          if [ ! -z "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Found existing PR #$PR_NUMBER"
          else
            echo "No PR found"
          fi

      - name: Add labels
        if: steps.check_pr.outputs.pr_number
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"

          # Add labels (will fail silently if labels don't exist)
          gh pr edit "$PR_NUMBER" --add-label "deployment,production" || true

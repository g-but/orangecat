# Refactoring Rules

## Branching Strategy
- All changes must be made in the `feature/slim-profiles` branch
- No direct commits to `main` during the refactor
- Create feature branches from `feature/slim-profiles` for specific tasks

## Migration Order
1. **File Moves**
   - Run migration script in dry-run mode
   - Review and confirm changes
   - Execute real migration
   - Fix any lint/build errors

2. **Database Migration**
   - Apply slim-profiles migration
   - Test on staging environment
   - Verify RLS policies
   - Test profile operations

3. **Frontend Scaffold**
   - Create new profile page
   - Implement unified hook
   - Build form component
   - Add tests

4. **Cleanup**
   - Remove old files
   - Update documentation
   - Run final tests
   - Prepare for merge

## Script Usage
1. Always start with dry-run:
   ```bash
   npm run migrate:features:dry-run
   ```
2. Review proposed changes carefully
3. Confirm with interactive prompt
4. Only run real migration after confirmation:
   ```bash
   npm run migrate:features
   ```

## Commit Conventions
- Use conventional commits:
  ```
  refactor: move files to feature-first structure
  feat: apply slim-profiles database migration
  feat: implement profile page and form
  chore: cleanup old files and update docs
  ```
- Keep commits focused and atomic
- Include relevant file changes in commit messages

## Testing Requirements
Before merging to `main`:
1. Run linting:
   ```bash
   npm run lint
   ```
2. Build the project:
   ```bash
   npm run build
   ```
3. Run all tests:
   ```bash
   npm run test
   ```
4. Verify no TypeScript errors

## Rollback Procedures
If something goes wrong:

1. **File Moves**
   ```bash
   # Use the rollback commands generated by the script
   git mv src/features/profile/hooks.ts src/hooks/useProfile.ts
   # ... other reverse moves
   ```

2. **Database Migration**
   ```bash
   # Revert the migration
   npx supabase migration down
   ```

3. **Code Changes**
   ```bash
   # Revert to previous commit
   git reset --hard HEAD~1
   ```

## Documentation Updates
- Keep `README.md` up to date
- Update `ARCHITECTURE.md` with new structure
- Document any breaking changes
- Add migration notes for future reference 
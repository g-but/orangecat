0e98af7066d2051d9e79040305a1be38
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@/services/supabase/client', () => {
    return {
        __esModule: true,
        default: {
            auth: {
                signInWithPassword: (...args) => mockSignInWithPassword(...args),
                signUp: (...args) => mockSignUp(...args),
                signOut: (...args) => mockSignOut(...args),
                getSession: (...args) => mockGetSession(...args),
            },
        },
    };
});
const auth_1 = require("@/services/supabase/auth");
const loggerUtils = __importStar(require("@/utils/logger"));
// Mock Supabase client and its auth methods
const mockSignInWithPassword = jest.fn();
const mockSignUp = jest.fn();
const mockSignOut = jest.fn();
const mockGetSession = jest.fn();
describe('Supabase auth service', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    it('signIn returns data on success & logs without leaking password', async () => {
        const fakeUser = { id: '123', email: 'test@example.com' };
        const fakeSession = { user: fakeUser };
        mockSignInWithPassword.mockResolvedValue({ data: { user: fakeUser, session: fakeSession }, error: null });
        // Spy on logAuth
        const logSpy = jest.spyOn(loggerUtils, 'logAuth');
        const { data, error } = await (0, auth_1.signIn)({ email: 'test@example.com', password: 'super-secret' });
        expect(error).toBeNull();
        expect(data).toEqual({ user: fakeUser, session: fakeSession });
        expect(mockSignInWithPassword).toHaveBeenCalledWith({ email: 'test@example.com', password: 'super-secret' });
        // Ensure no call to logAuth contains the raw password
        const leaked = logSpy.mock.calls.some(([, meta]) => JSON.stringify(meta).includes('super-secret'));
        expect(leaked).toBe(false);
    });
    it('signIn returns error when supabase returns error', async () => {
        const supabaseError = { message: 'Invalid credentials' };
        mockSignInWithPassword.mockResolvedValue({ data: { user: null, session: null }, error: supabaseError });
        const { data, error } = await (0, auth_1.signIn)({ email: 'foo@bar.com', password: 'wrong' });
        expect(error).toEqual(supabaseError);
        expect(data === null || data === void 0 ? void 0 : data.user).toBeNull();
    });
    it('signUp returns user/session on success', async () => {
        const fakeUser = { id: '42', email: 'new@user.com' };
        const fakeSession = { user: fakeUser };
        mockSignUp.mockResolvedValue({ data: { user: fakeUser, session: fakeSession }, error: null });
        const { data, error } = await (0, auth_1.signUp)({ email: fakeUser.email, password: 'Pa55w0rd' });
        expect(error).toBeNull();
        expect(data === null || data === void 0 ? void 0 : data.user).toEqual(fakeUser);
        expect(mockSignUp).toHaveBeenCalled();
    });
    it('signOut propagates supabase error', async () => {
        const supabaseError = { message: 'network error' };
        mockSignOut.mockResolvedValue({ error: supabaseError });
        const { error } = await (0, auth_1.signOut)();
        expect(error).toEqual(supabaseError);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3Rlc3RzL2F1dGgvYXV0aFNlcnZpY2UudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVNBLElBQUksQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQzNDLE9BQU87UUFDTCxVQUFVLEVBQUUsSUFBSTtRQUNoQixPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUU7Z0JBQ0osa0JBQWtCLEVBQUUsQ0FBQyxHQUFHLElBQWUsRUFBRSxFQUFFLENBQUMsc0JBQXNCLENBQUMsR0FBRyxJQUFJLENBQUM7Z0JBQzNFLE1BQU0sRUFBRSxDQUFDLEdBQUcsSUFBZSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUM7Z0JBQ25ELE9BQU8sRUFBRSxDQUFDLEdBQUcsSUFBZSxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7Z0JBQ3JELFVBQVUsRUFBRSxDQUFDLEdBQUcsSUFBZSxFQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDNUQ7U0FDRjtLQUNGLENBQUE7QUFDSCxDQUFDLENBQUMsQ0FBQTtBQXJCRixtREFBa0U7QUFDbEUsNERBQTZDO0FBRTdDLDRDQUE0QztBQUM1QyxNQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQTtBQUN4QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUE7QUFDNUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFBO0FBQzdCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQTtBQWdCaEMsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ3RCLENBQUMsQ0FBQyxDQUFBO0lBRUYsRUFB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QUFNLElBQUEsYUFBTSxFQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUE7UUFFckYsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3BDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO0lBQ3ZDLENBQUMsQ0FBQyxDQUFBO0lBRUYsRUFBRSxDQUFDLG1DQUFtQyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ2pELE1BQU0sYUFBYSxHQUFHLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFBO1FBQ2xELFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO1FBRXZELE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUEsY0FBTyxHQUFFLENBQUE7UUFFakMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUN0QyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2cvZGV2L29yYW5nZWNhdC90ZXN0cy9hdXRoL2F1dGhTZXJ2aWNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2lnbkluLCBzaWduVXAsIHNpZ25PdXQgfSBmcm9tICdAL3NlcnZpY2VzL3N1cGFiYXNlL2F1dGgnXG5pbXBvcnQgKiBhcyBsb2dnZXJVdGlscyBmcm9tICdAL3V0aWxzL2xvZ2dlcidcblxuLy8gTW9jayBTdXBhYmFzZSBjbGllbnQgYW5kIGl0cyBhdXRoIG1ldGhvZHNcbmNvbnN0IG1vY2tTaWduSW5XaXRoUGFzc3dvcmQgPSBqZXN0LmZuKClcbmNvbnN0IG1vY2tTaWduVXAgPSBqZXN0LmZuKClcbmNvbnN0IG1vY2tTaWduT3V0ID0gamVzdC5mbigpXG5jb25zdCBtb2NrR2V0U2Vzc2lvbiA9IGplc3QuZm4oKVxuXG5qZXN0Lm1vY2soJ0Avc2VydmljZXMvc3VwYWJhc2UvY2xpZW50JywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIF9fZXNNb2R1bGU6IHRydWUsXG4gICAgZGVmYXVsdDoge1xuICAgICAgYXV0aDoge1xuICAgICAgICBzaWduSW5XaXRoUGFzc3dvcmQ6ICguLi5hcmdzOiB1bmtub3duW10pID0+IG1vY2tTaWduSW5XaXRoUGFzc3dvcmQoLi4uYXJncyksXG4gICAgICAgIHNpZ25VcDogKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gbW9ja1NpZ25VcCguLi5hcmdzKSxcbiAgICAgICAgc2lnbk91dDogKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gbW9ja1NpZ25PdXQoLi4uYXJncyksXG4gICAgICAgIGdldFNlc3Npb246ICguLi5hcmdzOiB1bmtub3duW10pID0+IG1vY2tHZXRTZXNzaW9uKC4uLmFyZ3MpLFxuICAgICAgfSxcbiAgICB9LFxuICB9XG59KVxuXG5kZXNjcmliZSgnU3VwYWJhc2UgYXV0aCBzZXJ2aWNlJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuICB9KVxuXG4gIGl0KCdzaWduSW4gcmV0dXJucyBkYXRhIG9uIHN1Y2Nlc3MgJiBsb2dzIHdpdGhvdXQgbGVha2luZyBwYXNzd29yZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBmYWtlVXNlciA9IHsgaWQ6ICcxMjMnLCBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nIH1cbiAgICBjb25zdCBmYWtlU2Vzc2lvbiA9IHsgdXNlcjogZmFrZVVzZXIgfVxuICAgIG1vY2tTaWduSW5XaXRoUGFzc3dvcmQubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiB7IHVzZXI6IGZha2VVc2VyLCBzZXNzaW9uOiBmYWtlU2Vzc2lvbiB9LCBlcnJvcjogbnVsbCB9KVxuXG4gICAgLy8gU3B5IG9uIGxvZ0F1dGhcbiAgICBjb25zdCBsb2dTcHkgPSBqZXN0LnNweU9uKGxvZ2dlclV0aWxzLCAnbG9nQXV0aCcpXG5cbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzaWduSW4oeyBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLCBwYXNzd29yZDogJ3N1cGVyLXNlY3JldCcgfSlcblxuICAgIGV4cGVjdChlcnJvcikudG9CZU51bGwoKVxuICAgIGV4cGVjdChkYXRhKS50b0VxdWFsKHsgdXNlcjogZmFrZVVzZXIsIHNlc3Npb246IGZha2VTZXNzaW9uIH0pXG4gICAgZXhwZWN0KG1vY2tTaWduSW5XaXRoUGFzc3dvcmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJywgcGFzc3dvcmQ6ICdzdXBlci1zZWNyZXQnIH0pXG5cbiAgICAvLyBFbnN1cmUgbm8gY2FsbCB0byBsb2dBdXRoIGNvbnRhaW5zIHRoZSByYXcgcGFzc3dvcmRcbiAgICBjb25zdCBsZWFrZWQgPSAobG9nU3B5Lm1vY2suY2FsbHMgYXMgdW5rbm93bltdW10pLnNvbWUoKFssIG1ldGFdKSA9PiBKU09OLnN0cmluZ2lmeShtZXRhKS5pbmNsdWRlcygnc3VwZXItc2VjcmV0JykpXG4gICAgZXhwZWN0KGxlYWtlZCkudG9CZShmYWxzZSlcbiAgfSlcblxuICBpdCgnc2lnbkluIHJldHVybnMgZXJyb3Igd2hlbiBzdXBhYmFzZSByZXR1cm5zIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHN1cGFiYXNlRXJyb3IgPSB7IG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyB9XG4gICAgbW9ja1NpZ25JbldpdGhQYXNzd29yZC5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvcjogc3VwYWJhc2VFcnJvciB9KVxuXG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc2lnbkluKHsgZW1haWw6ICdmb29AYmFyLmNvbScsIHBhc3N3b3JkOiAnd3JvbmcnIH0pXG5cbiAgICBleHBlY3QoZXJyb3IpLnRvRXF1YWwoc3VwYWJhc2VFcnJvcilcbiAgICBleHBlY3QoZGF0YT8udXNlcikudG9CZU51bGwoKVxuICB9KVxuXG4gIGl0KCdzaWduVXAgcmV0dXJucyB1c2VyL3Nlc3Npb24gb24gc3VjY2VzcycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBmYWtlVXNlciA9IHsgaWQ6ICc0MicsIGVtYWlsOiAnbmV3QHVzZXIuY29tJyB9XG4gICAgY29uc3QgZmFrZVNlc3Npb24gPSB7IHVzZXI6IGZha2VVc2VyIH1cbiAgICBtb2NrU2lnblVwLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogeyB1c2VyOiBmYWtlVXNlciwgc2Vzc2lvbjogZmFrZVNlc3Npb24gfSwgZXJyb3I6IG51bGwgfSlcblxuICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHNpZ25VcCh7IGVtYWlsOiBmYWtlVXNlci5lbWFpbCwgcGFzc3dvcmQ6ICdQYTU1dzByZCcgfSlcblxuICAgIGV4cGVjdChlcnJvcikudG9CZU51bGwoKVxuICAgIGV4cGVjdChkYXRhPy51c2VyKS50b0VxdWFsKGZha2VVc2VyKVxuICAgIGV4cGVjdChtb2NrU2lnblVwKS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgfSlcblxuICBpdCgnc2lnbk91dCBwcm9wYWdhdGVzIHN1cGFiYXNlIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHN1cGFiYXNlRXJyb3IgPSB7IG1lc3NhZ2U6ICduZXR3b3JrIGVycm9yJyB9XG4gICAgbW9ja1NpZ25PdXQubW9ja1Jlc29sdmVkVmFsdWUoeyBlcnJvcjogc3VwYWJhc2VFcnJvciB9KVxuXG4gICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc2lnbk91dCgpXG5cbiAgICBleHBlY3QoZXJyb3IpLnRvRXF1YWwoc3VwYWJhc2VFcnJvcilcbiAgfSlcbn0pICJdLCJ2ZXJzaW9uIjozfQ==
c1086fdf293b93ed1935508d291e836a
"use strict";
/**
 * PROFILE WRITER MODULE
 *
 * Created: 2025-01-09
 * Last Modified: 2025-01-09
 * Last Modified Summary: Extracted from profileService.ts for modular architecture - handles write operations
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProfileWriter = void 0;
const client_1 = __importDefault(require("@/services/supabase/client"));
const logger_1 = require("@/utils/logger");
const mapper_1 = require("./mapper");
const reader_1 = require("./reader");
// =====================================================================
// ✏️ PROFILE WRITE OPERATIONS
// =====================================================================
class ProfileWriter {
    /**
     * Update profile with comprehensive field support
     */
    static async updateProfile(userId, formData) {
        var _a, _b;
        if (!(userId === null || userId === void 0 ? void 0 : userId.trim())) {
            return { success: false, error: 'User ID is required' };
        }
        try {
            // Verify authentication
            const { data: { user }, error: authError } = await client_1.default.auth.getUser();
            if (authError || !user) {
                return { success: false, error: 'No authenticated user. Please log in again.' };
            }
            if (user.id !== userId) {
                return { success: false, error: 'Permission denied: You can only update your own profile' };
            }
            (0, logger_1.logProfile)('updateProfile', { userId, formData });
            // Get current profile to merge with updates
            const currentProfile = await reader_1.ProfileReader.getProfile(userId);
            // Merge current profile with form data
            const updatedProfile = Object.assign(Object.assign(Object.assign({}, currentProfile), formData), { updated_at: new Date().toISOString(), last_active_at: new Date().toISOString() });
            // Map to database format
            const updateData = mapper_1.ProfileMapper.mapProfileToDatabase(updatedProfile);
            // Perform the update
            const { data, error } = await client_1.default
                .from('profiles')
                .update(updateData)
                .eq('id', userId)
                .select('*')
                .single();
            if (error) {
                logger_1.logger.error('ProfileWriter.updateProfile database error:', error);
                // Handle specific error cases
                if (error.code === '23505' && ((_a = error.message) === null || _a === void 0 ? void 0 : _a.includes('duplicate'))) {
                    return { success: false, error: 'Username is already taken. Please choose another username.' };
                }
                if ((_b = error.message) === null || _b === void 0 ? void 0 : _b.includes("'avatar_url'")) {
                    // Column missing, but treat as non-fatal and warn
                    return { success: true, warning: 'avatar_url column missing, profile saved without avatar', data: updatedProfile };
                }
                return { success: false, error: 'Failed to update profile. Please try again.' };
            }
            if (!data) {
                // Update succeeded but no data returned (likely RLS policy issue)
                // Fetch the updated profile separately
                const fetched = await reader_1.ProfileReader.getProfile(userId);
                if (fetched) {
                    (0, logger_1.logProfile)('updateProfile success (via separate fetch)', { userId, profile: fetched });
                    return { success: true, data: fetched };
                }
                else {
                    return { success: false, error: 'Profile update succeeded but could not retrieve updated data' };
                }
            }
            const finalProfile = mapper_1.ProfileMapper.mapDatabaseToProfile(data);
            (0, logger_1.logProfile)('updateProfile success', { userId, profile: finalProfile });
            return { success: true, data: finalProfile };
        }
        catch (err) {
            logger_1.logger.error('ProfileWriter.updateProfile unexpected error:', err);
            return { success: false, error: 'An unexpected error occurred while updating profile' };
        }
    }
    /**
     * Create a new profile
     */
    static async createProfile(userId, formData) {
        if (!(userId === null || userId === void 0 ? void 0 : userId.trim())) {
            return { success: false, error: 'User ID is required' };
        }
        try {
            (0, logger_1.logProfile)('createProfile', { userId, formData });
            // Prepare profile data
            const profileData = Object.assign(Object.assign({ id: userId }, formData), { created_at: new Date().toISOString(), updated_at: new Date().toISOString(), last_active_at: new Date().toISOString(), status: 'active', onboarding_completed: false, profile_views: 0, follower_count: 0, following_count: 0, campaign_count: 0, total_raised: 0, total_donated: 0 });
            // Map to database format
            const insertData = mapper_1.ProfileMapper.mapProfileToDatabase(profileData);
            insertData.id = userId; // Ensure ID is set
            const { data, error } = await client_1.default
                .from('profiles')
                .insert(insertData)
                .select('*')
                .single();
            if (error) {
                logger_1.logger.error('ProfileWriter.createProfile database error:', error);
                if (error.code === '23505') {
                    return { success: false, error: 'Profile already exists or username is taken' };
                }
                return { success: false, error: 'Failed to create profile. Please try again.' };
            }
            const newProfile = mapper_1.ProfileMapper.mapDatabaseToProfile(data);
            (0, logger_1.logProfile)('createProfile success', { userId, profile: newProfile });
            return { success: true, data: newProfile };
        }
        catch (err) {
            logger_1.logger.error('ProfileWriter.createProfile unexpected error:', err);
            return { success: false, error: 'An unexpected error occurred while creating profile' };
        }
    }
    /**
     * Update profile analytics
     */
    static async updateAnalytics(userId, analytics) {
        if (!(userId === null || userId === void 0 ? void 0 : userId.trim())) {
            return { success: false, error: 'User ID is required' };
        }
        try {
            // Get current profile
            const currentProfile = await reader_1.ProfileReader.getProfile(userId);
            if (!currentProfile) {
                return { success: false, error: 'Profile not found' };
            }
            // Merge analytics
            const updatedProfile = Object.assign(Object.assign(Object.assign({}, currentProfile), analytics), { updated_at: new Date().toISOString() });
            // Map to database format
            const updateData = mapper_1.ProfileMapper.mapProfileToDatabase(updatedProfile);
            const { error } = await client_1.default
                .from('profiles')
                .update(updateData)
                .eq('id', userId);
            if (error) {
                logger_1.logger.error('ProfileWriter.updateAnalytics error:', error);
                return { success: false, error: 'Failed to update analytics' };
            }
            return { success: true };
        }
        catch (err) {
            logger_1.logger.error('ProfileWriter.updateAnalytics unexpected error:', err);
            return { success: false, error: 'An unexpected error occurred while updating analytics' };
        }
    }
    /**
     * Delete profile
     */
    static async deleteProfile(userId) {
        if (!(userId === null || userId === void 0 ? void 0 : userId.trim())) {
            return { success: false, error: 'User ID is required' };
        }
        try {
            // Verify authentication
            const { data: { user }, error: authError } = await client_1.default.auth.getUser();
            if (authError || !user) {
                return { success: false, error: 'Authentication required' };
            }
            if (user.id !== userId) {
                return { success: false, error: 'Permission denied: Can only delete your own profile' };
            }
            (0, logger_1.logProfile)('deleteProfile', { userId });
            const { error } = await client_1.default
                .from('profiles')
                .delete()
                .eq('id', userId);
            if (error) {
                logger_1.logger.error('ProfileWriter.deleteProfile error:', error);
                return { success: false, error: 'Failed to delete profile' };
            }
            (0, logger_1.logProfile)('deleteProfile success', { userId });
            return { success: true };
        }
        catch (err) {
            logger_1.logger.error('ProfileWriter.deleteProfile unexpected error:', err);
            return { success: false, error: 'An unexpected error occurred while deleting profile' };
        }
    }
    /**
     * Fallback profile update (direct database update)
     */
    static async fallbackUpdate(userId, updates) {
        if (!(userId === null || userId === void 0 ? void 0 : userId.trim())) {
            return { success: false, error: 'User ID is required' };
        }
        try {
            // Prefer Postgres function for atomic profile update when available
            const { data, error } = await client_1.default.rpc('update_profile', {
                profile_data: updates
            });
            if (error) {
                logger_1.logger.error('ProfileWriter.fallbackUpdate error:', error);
                return { success: false, error: 'All profile update methods failed: ' + error.message };
            }
            return { success: true, data };
        }
        catch (err) {
            logger_1.logger.error('ProfileWriter.fallbackUpdate unexpected error:', err);
            return { success: false, error: 'An unexpected error occurred during fallback update' };
        }
    }
}
exports.ProfileWriter = ProfileWriter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9zZXJ2aWNlcy9wcm9maWxlL3dyaXRlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7Ozs7QUFFSCx3RUFBaUQ7QUFDakQsMkNBQW1EO0FBQ25ELHFDQUF3QztBQUN4QyxxQ0FBd0M7QUFHeEMsd0VBQXdFO0FBQ3hFLDhCQUE4QjtBQUM5Qix3RUFBd0U7QUFFeEUsTUFBYSxhQUFhO0lBRXhCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQ3hCLE1BQWMsRUFDZCxRQUFpQzs7UUFFakMsSUFBSSxDQUFDLENBQUEsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLElBQUksRUFBRSxDQUFBLEVBQUUsQ0FBQztZQUNwQixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUscUJBQXFCLEVBQUUsQ0FBQTtRQUN6RCxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsd0JBQXdCO1lBQ3hCLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEdBQUcsTUFBTSxnQkFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUUxRSxJQUFJLFNBQVMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsNkNBQTZDLEVBQUUsQ0FBQTtZQUNqRixDQUFDO1lBRUQsSUFBSSxJQUFJLENBQUMsRUFBRSxLQUFLLE1BQU0sRUFBRSxDQUFDO2dCQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUseURBQXlELEVBQUUsQ0FBQTtZQUM3RixDQUFDO1lBRUQsSUFBQSxtQkFBVSxFQUFDLGVBQWUsRUFBRSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFBO1lBRWpELDRDQUE0QztZQUM1QyxNQUFNLGNBQWMsR0FBRyxNQUFNLHNC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QUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxxREFBcUQsRUFBRSxDQUFBO1FBQ3pGLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF6UUQsc0NBeVFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2cvZGV2L29yYW5nZWNhdC9zcmMvc2VydmljZXMvcHJvZmlsZS93cml0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQUk9GSUxFIFdSSVRFUiBNT0RVTEVcbiAqIFxuICogQ3JlYXRlZDogMjAyNS0wMS0wOVxuICogTGFzdCBNb2RpZmllZDogMjAyNS0wMS0wOVxuICogTGFzdCBNb2RpZmllZCBTdW1tYXJ5OiBFeHRyYWN0ZWQgZnJvbSBwcm9maWxlU2VydmljZS50cyBmb3IgbW9kdWxhciBhcmNoaXRlY3R1cmUgLSBoYW5kbGVzIHdyaXRlIG9wZXJhdGlvbnNcbiAqL1xuXG5pbXBvcnQgc3VwYWJhc2UgZnJvbSAnQC9zZXJ2aWNlcy9zdXBhYmFzZS9jbGllbnQnXG5pbXBvcnQgeyBsb2dnZXIsIGxvZ1Byb2ZpbGUgfSBmcm9tICdAL3V0aWxzL2xvZ2dlcidcbmltcG9ydCB7IFByb2ZpbGVNYXBwZXIgfSBmcm9tICcuL21hcHBlcidcbmltcG9ydCB7IFByb2ZpbGVSZWFkZXIgfSBmcm9tICcuL3JlYWRlcidcbmltcG9ydCB0eXBlIHsgU2NhbGFibGVQcm9maWxlLCBTY2FsYWJsZVByb2ZpbGVGb3JtRGF0YSwgUHJvZmlsZUFuYWx5dGljcywgUHJvZmlsZVNlcnZpY2VSZXNwb25zZSB9IGZyb20gJy4vdHlwZXMnXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8g4pyP77iPIFBST0ZJTEUgV1JJVEUgT1BFUkFUSU9OU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjbGFzcyBQcm9maWxlV3JpdGVyIHtcbiAgXG4gIC8qKlxuICAgKiBVcGRhdGUgcHJvZmlsZSB3aXRoIGNvbXByZWhlbnNpdmUgZmllbGQgc3VwcG9ydFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHVwZGF0ZVByb2ZpbGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZm9ybURhdGE6IFNjYWxhYmxlUHJvZmlsZUZvcm1EYXRhXG4gICk6IFByb21pc2U8UHJvZmlsZVNlcnZpY2VSZXNwb25zZTxTY2FsYWJsZVByb2ZpbGU+PiB7XG4gICAgaWYgKCF1c2VySWQ/LnRyaW0oKSkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnVXNlciBJRCBpcyByZXF1aXJlZCcgfVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgYXV0aGVudGljYXRpb25cbiAgICAgIGNvbnN0IHsgZGF0YTogeyB1c2VyIH0sIGVycm9yOiBhdXRoRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguZ2V0VXNlcigpXG4gICAgICBcbiAgICAgIGlmIChhdXRoRXJyb3IgfHwgIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnTm8gYXV0aGVudGljYXRlZCB1c2VyLiBQbGVhc2UgbG9nIGluIGFnYWluLicgfVxuICAgICAgfVxuXG4gICAgICBpZiAodXNlci5pZCAhPT0gdXNlcklkKSB7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ1Blcm1pc3Npb24gZGVuaWVkOiBZb3UgY2FuIG9ubHkgdXBkYXRlIHlvdXIgb3duIHByb2ZpbGUnIH1cbiAgICAgIH1cblxuICAgICAgbG9nUHJvZmlsZSgndXBkYXRlUHJvZmlsZScsIHsgdXNlcklkLCBmb3JtRGF0YSB9KVxuXG4gICAgICAvLyBHZXQgY3VycmVudCBwcm9maWxlIHRvIG1lcmdlIHdpdGggdXBkYXRlc1xuICAgICAgY29uc3QgY3VycmVudFByb2ZpbGUgPSBhd2FpdCBQcm9maWxlUmVhZGVyLmdldFByb2ZpbGUodXNlcklkKTtcbiAgICAgIFxuICAgICAgLy8gTWVyZ2UgY3VycmVudCBwcm9maWxlIHdpdGggZm9ybSBkYXRhXG4gICAgICBjb25zdCB1cGRhdGVkUHJvZmlsZTogUGFydGlhbDxTY2FsYWJsZVByb2ZpbGU+ID0ge1xuICAgICAgICAuLi5jdXJyZW50UHJvZmlsZSxcbiAgICAgICAgLi4uZm9ybURhdGEsXG4gICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgbGFzdF9hY3RpdmVfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH1cblxuICAgICAgLy8gTWFwIHRvIGRhdGFiYXNlIGZvcm1hdFxuICAgICAgY29uc3QgdXBkYXRlRGF0YSA9IFByb2ZpbGVNYXBwZXIubWFwUHJvZmlsZVRvRGF0YWJhc2UodXBkYXRlZFByb2ZpbGUpO1xuXG4gICAgICAvLyBQZXJmb3JtIHRoZSB1cGRhdGVcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCdwcm9maWxlcycpXG4gICAgICAgIC51cGRhdGUodXBkYXRlRGF0YSlcbiAgICAgICAgLmVxKCdpZCcsIHVzZXJJZClcbiAgICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAgIC5zaW5nbGUoKVxuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdQcm9maWxlV3JpdGVyLnVwZGF0ZVByb2ZpbGUgZGF0YWJhc2UgZXJyb3I6JywgZXJyb3IpXG4gICAgICAgIFxuICAgICAgICAvLyBIYW5kbGUgc3BlY2lmaWMgZXJyb3IgY2FzZXNcbiAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICcyMzUwNScgJiYgZXJyb3IubWVzc2FnZT8uaW5jbHVkZXMoJ2R1cGxpY2F0ZScpKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnVXNlcm5hbWUgaXMgYWxyZWFkeSB0YWtlbi4gUGxlYXNlIGNob29zZSBhbm90aGVyIHVzZXJuYW1lLicgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoZXJyb3IubWVzc2FnZT8uaW5jbHVkZXMoXCInYXZhdGFyX3VybCdcIikpIHtcbiAgICAgICAgICAvLyBDb2x1bW4gbWlzc2luZywgYnV0IHRyZWF0IGFzIG5vbi1mYXRhbCBhbmQgd2FyblxuICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHdhcm5pbmc6ICdhdmF0YXJfdXJsIGNvbHVtbiBtaXNzaW5nLCBwcm9maWxlIHNhdmVkIHdpdGhvdXQgYXZhdGFyJywgZGF0YTogdXBkYXRlZFByb2ZpbGUgYXMgYW55IH0gYXMgYW55XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnRmFpbGVkIHRvIHVwZGF0ZSBwcm9maWxlLiBQbGVhc2UgdHJ5IGFnYWluLicgfVxuICAgICAgfVxuXG4gICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgLy8gVXBkYXRlIHN1Y2NlZWRlZCBidXQgbm8gZGF0YSByZXR1cm5lZCAobGlrZWx5IFJMUyBwb2xpY3kgaXNzdWUpXG4gICAgICAgIC8vIEZldGNoIHRoZSB1cGRhdGVkIHByb2ZpbGUgc2VwYXJhdGVseVxuICAgICAgICBjb25zdCBmZXRjaGVkID0gYXdhaXQgUHJvZmlsZVJlYWRlci5nZXRQcm9maWxlKHVzZXJJZCk7XG4gICAgICAgIGlmIChmZXRjaGVkKSB7XG4gICAgICAgICAgbG9nUHJvZmlsZSgndXBkYXRlUHJvZmlsZSBzdWNjZXNzICh2aWEgc2VwYXJhdGUgZmV0Y2gpJywgeyB1c2VySWQsIHByb2ZpbGU6IGZldGNoZWQgfSlcbiAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiBmZXRjaGVkIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdQcm9maWxlIHVwZGF0ZSBzdWNjZWVkZWQgYnV0IGNvdWxkIG5vdCByZXRyaWV2ZSB1cGRhdGVkIGRhdGEnIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBmaW5hbFByb2ZpbGUgPSBQcm9maWxlTWFwcGVyLm1hcERhdGFiYXNlVG9Qcm9maWxlKGRhdGEpO1xuICAgICAgbG9nUHJvZmlsZSgndXBkYXRlUHJvZmlsZSBzdWNjZXNzJywgeyB1c2VySWQsIHByb2ZpbGU6IGZpbmFsUHJvZmlsZSB9KVxuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiBmaW5hbFByb2ZpbGUgfVxuXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVXcml0ZXIudXBkYXRlUHJvZmlsZSB1bmV4cGVjdGVkIGVycm9yOicsIGVycilcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQgd2hpbGUgdXBkYXRpbmcgcHJvZmlsZScgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgcHJvZmlsZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGNyZWF0ZVByb2ZpbGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZm9ybURhdGE6IFNjYWxhYmxlUHJvZmlsZUZvcm1EYXRhXG4gICk6IFByb21pc2U8UHJvZmlsZVNlcnZpY2VSZXNwb25zZTxTY2FsYWJsZVByb2ZpbGU+PiB7XG4gICAgaWYgKCF1c2VySWQ/LnRyaW0oKSkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnVXNlciBJRCBpcyByZXF1aXJlZCcgfVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBsb2dQcm9maWxlKCdjcmVhdGVQcm9maWxlJywgeyB1c2VySWQsIGZvcm1EYXRhIH0pXG5cbiAgICAgIC8vIFByZXBhcmUgcHJvZmlsZSBkYXRhXG4gICAgICBjb25zdCBwcm9maWxlRGF0YTogUGFydGlhbDxTY2FsYWJsZVByb2ZpbGU+ID0ge1xuICAgICAgICBpZDogdXNlcklkLFxuICAgICAgICAuLi5mb3JtRGF0YSxcbiAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGxhc3RfYWN0aXZlX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIHN0YXR1czogJ2FjdGl2ZScsXG4gICAgICAgIG9uYm9hcmRpbmdfY29tcGxldGVkOiBmYWxzZSxcbiAgICAgICAgcHJvZmlsZV92aWV3czogMCxcbiAgICAgICAgZm9sbG93ZXJfY291bnQ6IDAsXG4gICAgICAgIGZvbGxvd2luZ19jb3VudDogMCxcbiAgICAgICAgY2FtcGFpZ25fY291bnQ6IDAsXG4gICAgICAgIHRvdGFsX3JhaXNlZDogMCxcbiAgICAgICAgdG90YWxfZG9uYXRlZDogMFxuICAgICAgfVxuXG4gICAgICAvLyBNYXAgdG8gZGF0YWJhc2UgZm9ybWF0XG4gICAgICBjb25zdCBpbnNlcnREYXRhID0gUHJvZmlsZU1hcHBlci5tYXBQcm9maWxlVG9EYXRhYmFzZShwcm9maWxlRGF0YSk7XG4gICAgICBpbnNlcnREYXRhLmlkID0gdXNlcklkOyAvLyBFbnN1cmUgSUQgaXMgc2V0XG5cbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCdwcm9maWxlcycpXG4gICAgICAgIC5pbnNlcnQoaW5zZXJ0RGF0YSlcbiAgICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAgIC5zaW5nbGUoKVxuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdQcm9maWxlV3JpdGVyLmNyZWF0ZVByb2ZpbGUgZGF0YWJhc2UgZXJyb3I6JywgZXJyb3IpXG4gICAgICAgIFxuICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJzIzNTA1Jykge1xuICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ1Byb2ZpbGUgYWxyZWFkeSBleGlzdHMgb3IgdXNlcm5hbWUgaXMgdGFrZW4nIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnRmFpbGVkIHRvIGNyZWF0ZSBwcm9maWxlLiBQbGVhc2UgdHJ5IGFnYWluLicgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBuZXdQcm9maWxlID0gUHJvZmlsZU1hcHBlci5tYXBEYXRhYmFzZVRvUHJvZmlsZShkYXRhKTtcbiAgICAgIGxvZ1Byb2ZpbGUoJ2NyZWF0ZVByb2ZpbGUgc3VjY2VzcycsIHsgdXNlcklkLCBwcm9maWxlOiBuZXdQcm9maWxlIH0pXG5cbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IG5ld1Byb2ZpbGUgfVxuXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVXcml0ZXIuY3JlYXRlUHJvZmlsZSB1bmV4cGVjdGVkIGVycm9yOicsIGVycilcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQgd2hpbGUgY3JlYXRpbmcgcHJvZmlsZScgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgcHJvZmlsZSBhbmFseXRpY3NcbiAgICovXG4gIHN0YXRpYyBhc3luYyB1cGRhdGVBbmFseXRpY3MoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgYW5hbHl0aWNzOiBQcm9maWxlQW5hbHl0aWNzXG4gICk6IFByb21pc2U8UHJvZmlsZVNlcnZpY2VSZXNwb25zZTx2b2lkPj4ge1xuICAgIGlmICghdXNlcklkPy50cmltKCkpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ1VzZXIgSUQgaXMgcmVxdWlyZWQnIH1cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gR2V0IGN1cnJlbnQgcHJvZmlsZVxuICAgICAgY29uc3QgY3VycmVudFByb2ZpbGUgPSBhd2FpdCBQcm9maWxlUmVhZGVyLmdldFByb2ZpbGUodXNlcklkKTtcbiAgICAgIGlmICghY3VycmVudFByb2ZpbGUpIHtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnUHJvZmlsZSBub3QgZm91bmQnIH1cbiAgICAgIH1cblxuICAgICAgLy8gTWVyZ2UgYW5hbHl0aWNzXG4gICAgICBjb25zdCB1cGRhdGVkUHJvZmlsZTogUGFydGlhbDxTY2FsYWJsZVByb2ZpbGU+ID0ge1xuICAgICAgICAuLi5jdXJyZW50UHJvZmlsZSxcbiAgICAgICAgLi4uYW5hbHl0aWNzLFxuICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH1cblxuICAgICAgLy8gTWFwIHRvIGRhdGFiYXNlIGZvcm1hdFxuICAgICAgY29uc3QgdXBkYXRlRGF0YSA9IFByb2ZpbGVNYXBwZXIubWFwUHJvZmlsZVRvRGF0YWJhc2UodXBkYXRlZFByb2ZpbGUpO1xuXG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgICAudXBkYXRlKHVwZGF0ZURhdGEpXG4gICAgICAgIC5lcSgnaWQnLCB1c2VySWQpXG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVXcml0ZXIudXBkYXRlQW5hbHl0aWNzIGVycm9yOicsIGVycm9yKVxuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdGYWlsZWQgdG8gdXBkYXRlIGFuYWx5dGljcycgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH1cblxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdQcm9maWxlV3JpdGVyLnVwZGF0ZUFuYWx5dGljcyB1bmV4cGVjdGVkIGVycm9yOicsIGVycilcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQgd2hpbGUgdXBkYXRpbmcgYW5hbHl0aWNzJyB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBwcm9maWxlXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZGVsZXRlUHJvZmlsZSh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8UHJvZmlsZVNlcnZpY2VSZXNwb25zZTx2b2lkPj4ge1xuICAgIGlmICghdXNlcklkPy50cmltKCkpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ1VzZXIgSUQgaXMgcmVxdWlyZWQnIH1cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gVmVyaWZ5IGF1dGhlbnRpY2F0aW9uXG4gICAgICBjb25zdCB7IGRhdGE6IHsgdXNlciB9LCBlcnJvcjogYXV0aEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFVzZXIoKVxuICAgICAgXG4gICAgICBpZiAoYXV0aEVycm9yIHx8ICF1c2VyKSB7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyB9XG4gICAgICB9XG5cbiAgICAgIGlmICh1c2VyLmlkICE9PSB1c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnUGVybWlzc2lvbiBkZW5pZWQ6IENhbiBvbmx5IGRlbGV0ZSB5b3VyIG93biBwcm9maWxlJyB9XG4gICAgICB9XG5cbiAgICAgIGxvZ1Byb2ZpbGUoJ2RlbGV0ZVByb2ZpbGUnLCB7IHVzZXJJZCB9KVxuXG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgICAuZGVsZXRlKClcbiAgICAgICAgLmVxKCdpZCcsIHVzZXJJZClcblxuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignUHJvZmlsZVdyaXRlci5kZWxldGVQcm9maWxlIGVycm9yOicsIGVycm9yKVxuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdGYWlsZWQgdG8gZGVsZXRlIHByb2ZpbGUnIH1cbiAgICAgIH1cblxuICAgICAgbG9nUHJvZmlsZSgnZGVsZXRlUHJvZmlsZSBzdWNjZXNzJywgeyB1c2VySWQgfSlcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfVxuXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVXcml0ZXIuZGVsZXRlUHJvZmlsZSB1bmV4cGVjdGVkIGVycm9yOicsIGVycilcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQgd2hpbGUgZGVsZXRpbmcgcHJvZmlsZScgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGYWxsYmFjayBwcm9maWxlIHVwZGF0ZSAoZGlyZWN0IGRhdGFiYXNlIHVwZGF0ZSlcbiAgICovXG4gIHN0YXRpYyBhc3luYyBmYWxsYmFja1VwZGF0ZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICB1cGRhdGVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICk6IFByb21pc2U8UHJvZmlsZVNlcnZpY2VSZXNwb25zZTxhbnk+PiB7XG4gICAgaWYgKCF1c2VySWQ/LnRyaW0oKSkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnVXNlciBJRCBpcyByZXF1aXJlZCcgfVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBQcmVmZXIgUG9zdGdyZXMgZnVuY3Rpb24gZm9yIGF0b21pYyBwcm9maWxlIHVwZGF0ZSB3aGVuIGF2YWlsYWJsZVxuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UucnBjKCd1cGRhdGVfcHJvZmlsZScsIHtcbiAgICAgICAgcHJvZmlsZV9kYXRhOiB1cGRhdGVzXG4gICAgICB9KVxuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdQcm9maWxlV3JpdGVyLmZhbGxiYWNrVXBkYXRlIGVycm9yOicsIGVycm9yKVxuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdBbGwgcHJvZmlsZSB1cGRhdGUgbWV0aG9kcyBmYWlsZWQ6ICcgKyBlcnJvci5tZXNzYWdlIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgZGF0YSB9XG5cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignUHJvZmlsZVdyaXRlci5mYWxsYmFja1VwZGF0ZSB1bmV4cGVjdGVkIGVycm9yOicsIGVycilcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGZhbGxiYWNrIHVwZGF0ZScgfVxuICAgIH1cbiAgfVxufSAiXSwidmVyc2lvbiI6M30=
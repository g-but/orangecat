ef4f8c478c36cf4f162040be94db7547
"use strict";
/**
 * PROFILE READER MODULE
 *
 * Created: 2025-01-09
 * Last Modified: 2025-01-09
 * Last Modified Summary: Extracted from profileService.ts for modular architecture - handles read operations
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProfileReader = void 0;
const client_1 = __importDefault(require("@/services/supabase/client"));
const logger_1 = require("@/utils/logger");
const mapper_1 = require("./mapper");
// =====================================================================
// ðŸ“– PROFILE RETRIEVAL OPERATIONS
// =====================================================================
class ProfileReader {
    /**
     * Get a complete profile with all scalable fields
     */
    static async getProfile(userId) {
        // Explicit check for empty/invalid user IDs
        if (!userId || typeof userId !== 'string' || !userId.trim()) {
            logger_1.logger.warn('ProfileReader.getProfile: Invalid or empty user ID provided', { userId });
            return null;
        }
        try {
            (0, logger_1.logProfile)('getProfile', { userId });
            const { data, error } = await client_1.default
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            if (error) {
                if (error.code === 'PGRST116') {
                    logger_1.logger.info(`Profile not found for user: ${userId}`);
                    return null;
                }
                logger_1.logger.error('ProfileReader.getProfile error:', error);
                return null;
            }
            if (!data) {
                return null;
            }
            const profile = mapper_1.ProfileMapper.mapDatabaseToProfile(data);
            (0, logger_1.logProfile)('getProfile success', { userId, hasProfile: true });
            return profile;
        }
        catch (err) {
            logger_1.logger.error('ProfileReader.getProfile unexpected error:', err);
            return null;
        }
    }
    /**
     * Get multiple profiles with pagination and filtering
     */
    static async getProfiles(options = {}) {
        try {
            const { limit = 20, offset = 0, orderBy = 'created_at', orderDirection = 'desc' } = options;
            const { data, error } = await client_1.default
                .from('profiles')
                .select('*')
                .order(orderBy, { ascending: orderDirection === 'asc' })
                .range(offset, offset + limit - 1);
            if (error) {
                logger_1.logger.error('ProfileReader.getProfiles error:', { message: error.message, code: error.code });
                return [];
            }
            return (data === null || data === void 0 ? void 0 : data.map(profile => mapper_1.ProfileMapper.mapDatabaseToProfile(profile))) || [];
        }
        catch (err) {
            logger_1.logger.error('ProfileReader.getProfiles unexpected error:', err);
            return [];
        }
    }
    /**
     * Search profiles with basic text search
     */
    static async searchProfiles(searchTerm, limit = 20, offset = 0) {
        if (!(searchTerm === null || searchTerm === void 0 ? void 0 : searchTerm.trim())) {
            return [];
        }
        try {
            const { data, error } = await client_1.default
                .from('profiles')
                .select('*')
                .or(`username.ilike.%${searchTerm}%,full_name.ilike.%${searchTerm}%`)
                .order('created_at', { ascending: false })
                .range(offset, offset + limit - 1);
            if (error) {
                logger_1.logger.error('ProfileReader.searchProfiles error:', error);
                return [];
            }
            return (data === null || data === void 0 ? void 0 : data.map(profile => mapper_1.ProfileMapper.mapDatabaseToProfile(profile))) || [];
        }
        catch (err) {
            logger_1.logger.error('ProfileReader.searchProfiles unexpected error:', err);
            return [];
        }
    }
    /**
     * Get all profiles (admin function)
     */
    static async getAllProfiles() {
        try {
            const { data, error } = await client_1.default
                .from('profiles')
                .select('*')
                .order('created_at', { ascending: false });
            if (error) {
                logger_1.logger.error('ProfileReader.getAllProfiles error:', error);
                return [];
            }
            return (data === null || data === void 0 ? void 0 : data.map(profile => mapper_1.ProfileMapper.mapDatabaseToProfile(profile))) || [];
        }
        catch (err) {
            logger_1.logger.error('ProfileReader.getAllProfiles unexpected error:', err);
            return [];
        }
    }
    /**
     * Increment profile views (read-adjacent operation)
     */
    static async incrementProfileViews(userId) {
        if (!(userId === null || userId === void 0 ? void 0 : userId.trim()))
            return;
        try {
            // Get current view count
            const profile = await this.getProfile(userId);
            if (!profile)
                return;
            const currentViews = profile.profile_views || 0;
            // Update view count
            await client_1.default
                .from('profiles')
                .update({
                website: JSON.stringify(Object.assign(Object.assign({}, JSON.parse(profile.website || '{}')), { profile_views: currentViews + 1, last_viewed_at: new Date().toISOString() }))
            })
                .eq('id', userId);
        }
        catch (err) {
            logger_1.logger.error('ProfileReader.incrementProfileViews error:', err);
        }
    }
}
exports.ProfileReader = ProfileReader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9zZXJ2aWNlcy9wcm9maWxlL3JlYWRlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7Ozs7QUFFSCx3RUFBaUQ7QUFDakQsMkNBQW1EO0FBQ25ELHFDQUF3QztBQUd4Qyx3RUFBd0U7QUFDeEUsa0NBQWtDO0FBQ2xDLHdFQUF3RTtBQUV4RSxNQUFhLGFBQWE7SUFFeEI7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFjO1FBQ3BDLDRDQUE0QztRQUM1QyxJQUFJLENBQUMsTUFBTSxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQzVELGVBQU0sQ0FBQyxJQUFJLENBQUMsNkRBQTZELEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1lBQ3RGLE9BQU8sSUFBSSxDQUFBO1FBQ2IsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILElBQUEsbUJBQVUsRUFBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1lBRXBDLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxnQkFBUTtpQkFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQztpQkFDaEIsTUFBTSxDQUFDLEdBQUcsQ0FBQztpQkFDWCxFQUFFLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQztpQkFDaEIsTUFBTSxFQUFFLENBQUE7WUFFWCxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUNWLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUUsQ0FBQztvQkFDOUIsZUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsTUFBTSxFQUFFLENBQUMsQ0FBQTtvQkFDcEQsT0FBTyxJQUFJLENBQUE7Z0JBQ2IsQ0FBQztnQkFDRCxlQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFBO2dCQUN0RCxPQUFPLElBQUksQ0FB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QUFjO1FBQy9DLElBQUksQ0FBQyxDQUFBLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxJQUFJLEVBQUUsQ0FBQTtZQUFFLE9BQU07UUFFM0IsSUFBSSxDQUFDO1lBQ0gseUJBQXlCO1lBQ3pCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUM3QyxJQUFJLENBQUMsT0FBTztnQkFBRSxPQUFNO1lBRXBCLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxhQUFhLElBQUksQ0FBQyxDQUFBO1lBRS9DLG9CQUFvQjtZQUNwQixNQUFNLGdCQUFRO2lCQUNYLElBQUksQ0FBQyxVQUFVLENBQUM7aUJBQ2hCLE1BQU0sQ0FBQztnQkFDTixPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsaUNBQ2xCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsS0FDdEMsYUFBYSxFQUFFLFlBQVksR0FBRyxDQUFDLEVBQy9CLGNBQWMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxJQUN4QzthQUNILENBQUM7aUJBQ0QsRUFBRSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUVyQixDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLGVBQU0sQ0FBQyxLQUFLLENBQUMsNENBQTRDLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDakUsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXJLRCxzQ0FxS0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9zZXJ2aWNlcy9wcm9maWxlL3JlYWRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFBST0ZJTEUgUkVBREVSIE1PRFVMRVxuICogXG4gKiBDcmVhdGVkOiAyMDI1LTAxLTA5XG4gKiBMYXN0IE1vZGlmaWVkOiAyMDI1LTAxLTA5XG4gKiBMYXN0IE1vZGlmaWVkIFN1bW1hcnk6IEV4dHJhY3RlZCBmcm9tIHByb2ZpbGVTZXJ2aWNlLnRzIGZvciBtb2R1bGFyIGFyY2hpdGVjdHVyZSAtIGhhbmRsZXMgcmVhZCBvcGVyYXRpb25zXG4gKi9cblxuaW1wb3J0IHN1cGFiYXNlIGZyb20gJ0Avc2VydmljZXMvc3VwYWJhc2UvY2xpZW50J1xuaW1wb3J0IHsgbG9nZ2VyLCBsb2dQcm9maWxlIH0gZnJvbSAnQC91dGlscy9sb2dnZXInXG5pbXBvcnQgeyBQcm9maWxlTWFwcGVyIH0gZnJvbSAnLi9tYXBwZXInXG5pbXBvcnQgdHlwZSB7IFNjYWxhYmxlUHJvZmlsZSB9IGZyb20gJy4vdHlwZXMnXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8g8J+TliBQUk9GSUxFIFJFVFJJRVZBTCBPUEVSQVRJT05TXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGNsYXNzIFByb2ZpbGVSZWFkZXIge1xuICBcbiAgLyoqXG4gICAqIEdldCBhIGNvbXBsZXRlIHByb2ZpbGUgd2l0aCBhbGwgc2NhbGFibGUgZmllbGRzXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0UHJvZmlsZSh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8U2NhbGFibGVQcm9maWxlIHwgbnVsbD4ge1xuICAgIC8vIEV4cGxpY2l0IGNoZWNrIGZvciBlbXB0eS9pbnZhbGlkIHVzZXIgSURzXG4gICAgaWYgKCF1c2VySWQgfHwgdHlwZW9mIHVzZXJJZCAhPT0gJ3N0cmluZycgfHwgIXVzZXJJZC50cmltKCkpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdQcm9maWxlUmVhZGVyLmdldFByb2ZpbGU6IEludmFsaWQgb3IgZW1wdHkgdXNlciBJRCBwcm92aWRlZCcsIHsgdXNlcklkIH0pXG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBsb2dQcm9maWxlKCdnZXRQcm9maWxlJywgeyB1c2VySWQgfSlcblxuICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgICAgLmZyb20oJ3Byb2ZpbGVzJylcbiAgICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAgIC5lcSgnaWQnLCB1c2VySWQpXG4gICAgICAgIC5zaW5nbGUoKVxuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdQR1JTVDExNicpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhgUHJvZmlsZSBub3QgZm91bmQgZm9yIHVzZXI6ICR7dXNlcklkfWApXG4gICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVSZWFkZXIuZ2V0UHJvZmlsZSBlcnJvcjonLCBlcnJvcilcbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgIH1cblxuICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgIHJldHVybiBudWxsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb2ZpbGUgPSBQcm9maWxlTWFwcGVyLm1hcERhdGFiYXNlVG9Qcm9maWxlKGRhdGEpO1xuICAgICAgbG9nUHJvZmlsZSgnZ2V0UHJvZmlsZSBzdWNjZXNzJywgeyB1c2VySWQsIGhhc1Byb2ZpbGU6IHRydWUgfSlcbiAgICAgIHJldHVybiBwcm9maWxlXG5cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignUHJvZmlsZVJlYWRlci5nZXRQcm9maWxlIHVuZXhwZWN0ZWQgZXJyb3I6JywgZXJyKVxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IG11bHRpcGxlIHByb2ZpbGVzIHdpdGggcGFnaW5hdGlvbiBhbmQgZmlsdGVyaW5nXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0UHJvZmlsZXMob3B0aW9uczoge1xuICAgIGxpbWl0PzogbnVtYmVyXG4gICAgb2Zmc2V0PzogbnVtYmVyXG4gICAgb3JkZXJCeT86IHN0cmluZ1xuICAgIG9yZGVyRGlyZWN0aW9uPzogJ2FzYycgfCAnZGVzYydcbiAgfSA9IHt9KTogUHJvbWlzZTxTY2FsYWJsZVByb2ZpbGVbXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGxpbWl0ID0gMjAsXG4gICAgICAgIG9mZnNldCA9IDAsXG4gICAgICAgIG9yZGVyQnkgPSAnY3JlYXRlZF9hdCcsXG4gICAgICAgIG9yZGVyRGlyZWN0aW9uID0gJ2Rlc2MnXG4gICAgICB9ID0gb3B0aW9uc1xuXG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgICAuc2VsZWN0KCcqJylcbiAgICAgICAgLm9yZGVyKG9yZGVyQnksIHsgYXNjZW5kaW5nOiBvcmRlckRpcmVjdGlvbiA9PT0gJ2FzYycgfSlcbiAgICAgICAgLnJhbmdlKG9mZnNldCwgb2Zmc2V0ICsgbGltaXQgLSAxKVxuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdQcm9maWxlUmVhZGVyLmdldFByb2ZpbGVzIGVycm9yOicsIHsgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwgY29kZTogZXJyb3IuY29kZSB9KVxuICAgICAgICByZXR1cm4gW11cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRhdGE/Lm1hcChwcm9maWxlID0+IFByb2ZpbGVNYXBwZXIubWFwRGF0YWJhc2VUb1Byb2ZpbGUocHJvZmlsZSkpIHx8IFtdXG5cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignUHJvZmlsZVJlYWRlci5nZXRQcm9maWxlcyB1bmV4cGVjdGVkIGVycm9yOicsIGVycilcbiAgICAgIHJldHVybiBbXVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZWFyY2ggcHJvZmlsZXMgd2l0aCBiYXNpYyB0ZXh0IHNlYXJjaFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHNlYXJjaFByb2ZpbGVzKFxuICAgIHNlYXJjaFRlcm06IHN0cmluZyxcbiAgICBsaW1pdDogbnVtYmVyID0gMjAsXG4gICAgb2Zmc2V0OiBudW1iZXIgPSAwXG4gICk6IFByb21pc2U8U2NhbGFibGVQcm9maWxlW10+IHtcbiAgICBpZiAoIXNlYXJjaFRlcm0/LnRyaW0oKSkge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCdwcm9maWxlcycpXG4gICAgICAgIC5zZWxlY3QoJyonKVxuICAgICAgICAub3IoYHVzZXJuYW1lLmlsaWtlLiUke3NlYXJjaFRlcm19JSxmdWxsX25hbWUuaWxpa2UuJSR7c2VhcmNoVGVybX0lYClcbiAgICAgICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pXG4gICAgICAgIC5yYW5nZShvZmZzZXQsIG9mZnNldCArIGxpbWl0IC0gMSlcblxuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignUHJvZmlsZVJlYWRlci5zZWFyY2hQcm9maWxlcyBlcnJvcjonLCBlcnJvcilcbiAgICAgICAgcmV0dXJuIFtdXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkYXRhPy5tYXAocHJvZmlsZSA9PiBQcm9maWxlTWFwcGVyLm1hcERhdGFiYXNlVG9Qcm9maWxlKHByb2ZpbGUpKSB8fCBbXVxuXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVSZWFkZXIuc2VhcmNoUHJvZmlsZXMgdW5leHBlY3RlZCBlcnJvcjonLCBlcnIpXG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBwcm9maWxlcyAoYWRtaW4gZnVuY3Rpb24pXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0QWxsUHJvZmlsZXMoKTogUHJvbWlzZTxTY2FsYWJsZVByb2ZpbGVbXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgICAuc2VsZWN0KCcqJylcbiAgICAgICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pXG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ1Byb2ZpbGVSZWFkZXIuZ2V0QWxsUHJvZmlsZXMgZXJyb3I6JywgZXJyb3IpXG4gICAgICAgIHJldHVybiBbXVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGF0YT8ubWFwKHByb2ZpbGUgPT4gUHJvZmlsZU1hcHBlci5tYXBEYXRhYmFzZVRvUHJvZmlsZShwcm9maWxlKSkgfHwgW11cblxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdQcm9maWxlUmVhZGVyLmdldEFsbFByb2ZpbGVzIHVuZXhwZWN0ZWQgZXJyb3I6JywgZXJyKVxuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEluY3JlbWVudCBwcm9maWxlIHZpZXdzIChyZWFkLWFkamFjZW50IG9wZXJhdGlvbilcbiAgICovXG4gIHN0YXRpYyBhc3luYyBpbmNyZW1lbnRQcm9maWxlVmlld3ModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXVzZXJJZD8udHJpbSgpKSByZXR1cm5cblxuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgY3VycmVudCB2aWV3IGNvdW50XG4gICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgdGhpcy5nZXRQcm9maWxlKHVzZXJJZClcbiAgICAgIGlmICghcHJvZmlsZSkgcmV0dXJuXG5cbiAgICAgIGNvbnN0IGN1cnJlbnRWaWV3cyA9IHByb2ZpbGUucHJvZmlsZV92aWV3cyB8fCAwXG4gICAgICBcbiAgICAgIC8vIFVwZGF0ZSB2aWV3IGNvdW50XG4gICAgICBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgICAudXBkYXRlKHsgXG4gICAgICAgICAgd2Vic2l0ZTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgLi4uSlNPTi5wYXJzZShwcm9maWxlLndlYnNpdGUgfHwgJ3t9JyksXG4gICAgICAgICAgICBwcm9maWxlX3ZpZXdzOiBjdXJyZW50Vmlld3MgKyAxLFxuICAgICAgICAgICAgbGFzdF92aWV3ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICAgIC5lcSgnaWQnLCB1c2VySWQpXG5cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignUHJvZmlsZVJlYWRlci5pbmNyZW1lbnRQcm9maWxlVmlld3MgZXJyb3I6JywgZXJyKVxuICAgIH1cbiAgfVxufSAiXSwidmVyc2lvbiI6M30=
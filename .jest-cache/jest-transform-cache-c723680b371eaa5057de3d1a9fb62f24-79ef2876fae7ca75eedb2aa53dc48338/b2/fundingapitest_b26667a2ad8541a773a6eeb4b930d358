8d1093bc95772341900a77d11b52f214
"use strict";
/**
 * Funding API Endpoint Tests
 *
 * Testing critical funding API that handles funding page transactions
 * Essential for Bitcoin platform transaction processing
 */
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@/services/supabase/server', () => ({
    createServerClient: jest.fn(() => Promise.resolve(mockSupabaseClient))
}));
// Mock the logger
jest.mock('@/utils/logger', () => ({
    logger: {
        warn: jest.fn(),
        error: jest.fn(),
        info: jest.fn(),
    }
}));
const route_1 = require("../funding/route");
// More robust mock for Supabase server client
const mockSupabaseClient = {
    from: jest.fn(),
    auth: {
        getUser: jest.fn(),
    }
};
describe('ðŸ’° Funding API Endpoint - Transaction Processing', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        // Reset all mocks to a default successful state
        const fromChain = {
            select: jest.fn().mockReturnThis(),
            insert: jest.fn().mockReturnThis(),
            eq: jest.fn().mockReturnThis(),
            single: jest.fn().mockResolvedValue({ data: {}, error: null }),
        };
        mockSupabaseClient.from.mockReturnValue(fromChain);
        // Default mock user
        mockSupabaseClient.auth.getUser.mockResolvedValue({
            data: { user: { id: 'test-user-authed' } },
            error: null,
        });
    });
    describe('ðŸ” GET /api/funding - Funding Pages Retrieval', () => {
        test('should fetch user\'s own funding pages successfully', async () => {
            const mockFundingPages = [
                { id: 'fp-1', title: 'My Project', user_id: 'test-user-authed' },
            ];
            const selectMock = jest.fn().mockResolvedValue({ data: mockFundingPages, error: null });
            mockSupabaseClient.from.mockReturnValue({
                select: jest.fn().mockReturnThis(),
                eq: selectMock, // GET for user's pages uses .eq('user_id', user.id)
            });
            const request = { url: 'http://localhost:3000/api/funding' };
            const response = await (0, route_1.GET)(request);
            const data = await response.json();
            expect(response.status).toBe(200);
            expect(data.fundingPages).toEqual(mockFundingPages);
            expect(mockSupabaseClient.from).toHaveBeenCalledWith('funding_pages');
            // The implementation forces filtering by authenticated user
            expect(selectMock).toHaveBeenCalledWith('user_id', 'test-user-authed');
        });
        test('should return 403 when trying to access another user\'s pages', async () => {
            const request = { url: 'http://localhost:3000/api/funding?userId=other-user' };
            const response = await (0, route_1.GET)(request);
            const data = await response.json();
            expect(response.status).toBe(403);
            expect(data.error).toBe('Cannot access other users\' funding data');
        });
        test('should filter funding pages by status', async () => {
            const mockActiveFundingPages = [{ id: 'fp-active', status: 'active' }];
            const eqMockStatus = jest.fn().mockResolvedValue({ data: mockActiveFundingPages, error: null });
            const eqMockUser = jest.fn().mockReturnValue({ eq: eqMockStatus });
            mockSupabaseClient.from.mockReturnValue({
                select: jest.fn().mockReturnThis(),
                eq: eqMockUser,
            });
            const request = { url: 'http://localhost:3000/api/funding?status=active' };
            const response = await (0, route_1.GET)(request);
            const data = await response.json();
            expect(response.status).toBe(200);
            expect(data.fundingPages).toEqual(mockActiveFundingPages);
            expect(eqMockUser).toHaveBeenCalledWith('user_id', 'test-user-authed');
            expect(eqMockStatus).toHaveBeenCalledWith('status', 'active');
        });
        test('should handle database errors gracefully during GET', async () => {
            mockSupabaseClient.from.mockReturnValue({
                select: jest.fn().mockReturnThis(),
                eq: jest.fn().mockResolvedValue({ data: null, error: { message: 'DB Error' } }),
            });
            const request = { url: 'http://localhost:3000/api/funding' };
            const response = await (0, route_1.GET)(request);
            const data = await response.json();
            expect(response.status).toBe(500);
            expect(data.error).toBe('Failed to fetch funding pages');
        });
    });
    describe('ðŸ“® POST /api/funding - Transaction Creation', () => {
        test('should require authentication to create a transaction', async () => {
            mockSupabaseClient.auth.getUser.mockResolvedValue({ data: { user: null }, error: { message: 'No auth' } });
            const request = {
                method: 'POST',
                json: () => Promise.resolve({}),
                url: 'http://localhost:3000/api/funding'
            };
            const response = await (0, route_1.POST)(request);
            const data = await response.json();
            expect(response.status).toBe(401);
            expect(data.error).toBe('Authentication required to create transactions');
        });
        test('should reject transaction with missing fields', async () => {
            const request = {
                method: 'POST',
                json: () => Promise.resolve({ amount: 100, currency: 'BTC' }), // missing fundingPageId and paymentMethod
                url: 'http://localhost:3000/api/funding'
            };
            const response = await (0, route_1.POST)(request);
            const data = await response.json();
            expect(response.status).toBe(400);
            expect(data.error).toBe('All fields are required');
        });
        test('should create a transaction successfully', async () => {
            // Clear all previous mocks for this specific test
            jest.clearAllMocks();
            const fundingPageId = 'fp-owned-by-user';
            const transactionData = {
                fundingPageId,
                amount: 1000,
                currency: 'sats',
                paymentMethod: 'lightning',
            };
            // Reset to default successful auth state
            mockSupabaseClient.auth.getUser.mockResolvedValue({
                data: { user: { id: 'test-user-authed' } },
                error: null,
            });
            // Mock funding page ownership check
            mockSupabaseClient.from.mockImplementation((tableName) => {
                if (tableName === 'funding_pages') {
                    return {
                        select: jest.fn().mockReturnThis(),
                        eq: jest.fn().mockReturnThis(),
                        single: jest.fn().mockResolvedValue({
                            data: { user_id: 'test-user-authed', status: 'active' },
                            error: null
                        }),
                    };
                }
                if (tableName === 'transactions') {
                    return {
                        insert: jest.fn().mockReturnThis(),
                        select: jest.fn().mockReturnThis(),
                        single: jest.fn().mockResolvedValue({ data: Object.assign(Object.assign({ id: 'new-tx-id' }, transactionData), { user_id: 'test-user-authed' }), error: null }),
                    };
                }
                return { from: jest.fn() };
            });
            const request = {
                method: 'POST',
                json: () => Promise.resolve(transactionData),
                url: 'http://localhost:3000/api/funding'
            };
            const response = await (0, route_1.POST)(request);
            const data = await response.json();
            expect(response.status).toBe(200);
            expect(data.message).toBe('Transaction created successfully');
            expect(data.transaction.id).toBe('new-tx-id');
        });
        test('should handle database insertion errors during POST', async () => {
            mockSupabaseClient.from.mockReturnValue({
                select: jest.fn().mockReturnThis(),
                eq: jest.fn().mockResolvedValue({ data: { user_id: 'test-user-authed', status: 'active' }, error: null }),
                insert: jest.fn().mockReturnThis(),
                single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Insert failed' } }),
            });
            const request = {
                method: 'POST',
                json: () => Promise.resolve({ fundingPageId: 'fp-1', amount: 100, currency: 'BTC', paymentMethod: 'bitcoin' }),
                url: 'http://localhost:3000/api/funding'
            };
            const response = await (0, route_1.POST)(request);
            const data = await response.json();
            expect(response.status).toBe(500);
            expect(data.error).toBe('Failed to create transaction');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9hcHAvYXBpL19fdGVzdHNfXy9mdW5kaW5nLmFwaS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7QUFhSCxJQUFJLENBQUMsSUFBSSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDN0Msa0JBQWtCLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7Q0FDdkUsQ0FBQyxDQUFDLENBQUM7QUFFSixrQkFBa0I7QUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQy9CLE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDaEI7Q0FDSixDQUFDLENBQUMsQ0FBQztBQXJCSiw0Q0FBNkM7QUFFN0MsOENBQThDO0FBQzlDLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDZixJQUFJLEVBQUU7UUFDSixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNuQjtDQUNGLENBQUM7QUFnQkYsUUFBUSxDQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRTtJQUVoRSxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLGdEQUFnRDtRQUNoRCxNQUFNLFNBQVMsR0FBRztZQUNoQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtZQUNsQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtZQUNsQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUs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Q0FBQyxpQkFBaUIsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFLENBQUM7YUFDM0YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLEdBQUc7Z0JBQ1osTUFBTSxFQUFFLE1BQU07Z0JBQ2QsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxhQUFhLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLENBQUM7Z0JBQzlHLEdBQUcsRUFBRSxtQ0FBbUM7YUFDcEMsQ0FBQztZQUVULE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxZQUFJLEVBQUMsT0FBTyxDQUFDLENBQUM7WUFDckMsTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFbkMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbEMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FBQztJQUVMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9hcHAvYXBpL19fdGVzdHNfXy9mdW5kaW5nLmFwaS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRnVuZGluZyBBUEkgRW5kcG9pbnQgVGVzdHNcbiAqIFxuICogVGVzdGluZyBjcml0aWNhbCBmdW5kaW5nIEFQSSB0aGF0IGhhbmRsZXMgZnVuZGluZyBwYWdlIHRyYW5zYWN0aW9uc1xuICogRXNzZW50aWFsIGZvciBCaXRjb2luIHBsYXRmb3JtIHRyYW5zYWN0aW9uIHByb2Nlc3NpbmdcbiAqL1xuXG5pbXBvcnQgeyBOZXh0UmVxdWVzdCB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7IEdFVCwgUE9TVCB9IGZyb20gJy4uL2Z1bmRpbmcvcm91dGUnO1xuXG4vLyBNb3JlIHJvYnVzdCBtb2NrIGZvciBTdXBhYmFzZSBzZXJ2ZXIgY2xpZW50XG5jb25zdCBtb2NrU3VwYWJhc2VDbGllbnQgPSB7XG4gIGZyb206IGplc3QuZm4oKSxcbiAgYXV0aDoge1xuICAgIGdldFVzZXI6IGplc3QuZm4oKSxcbiAgfVxufTtcblxuamVzdC5tb2NrKCdAL3NlcnZpY2VzL3N1cGFiYXNlL3NlcnZlcicsICgpID0+ICh7XG4gIGNyZWF0ZVNlcnZlckNsaWVudDogamVzdC5mbigoKSA9PiBQcm9taXNlLnJlc29sdmUobW9ja1N1cGFiYXNlQ2xpZW50KSlcbn0pKTtcblxuLy8gTW9jayB0aGUgbG9nZ2VyXG5qZXN0Lm1vY2soJ0AvdXRpbHMvbG9nZ2VyJywgKCkgPT4gKHtcbiAgICBsb2dnZXI6IHtcbiAgICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgICBpbmZvOiBqZXN0LmZuKCksXG4gICAgfVxufSkpO1xuXG5cbmRlc2NyaWJlKCfwn5KwIEZ1bmRpbmcgQVBJIEVuZHBvaW50IC0gVHJhbnNhY3Rpb24gUHJvY2Vzc2luZycsICgpID0+IHtcbiAgICBcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgXG4gICAgLy8gUmVzZXQgYWxsIG1vY2tzIHRvIGEgZGVmYXVsdCBzdWNjZXNzZnVsIHN0YXRlXG4gICAgY29uc3QgZnJvbUNoYWluID0ge1xuICAgICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBlcTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBzaW5nbGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IHt9LCBlcnJvcjogbnVsbCB9KSxcbiAgICB9O1xuICAgIG1vY2tTdXBhYmFzZUNsaWVudC5mcm9tLm1vY2tSZXR1cm5WYWx1ZShmcm9tQ2hhaW4pO1xuICAgIFxuICAgIC8vIERlZmF1bHQgbW9jayB1c2VyXG4gICAgbW9ja1N1cGFiYXNlQ2xpZW50LmF1dGguZ2V0VXNlci5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIGRhdGE6IHsgdXNlcjogeyBpZDogJ3Rlc3QtdXNlci1hdXRoZWQnIH0gfSxcbiAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCfwn5SNIEdFVCAvYXBpL2Z1bmRpbmcgLSBGdW5kaW5nIFBhZ2VzIFJldHJpZXZhbCcsICgpID0+IHtcbiAgICBcbiAgICB0ZXN0KCdzaG91bGQgZmV0Y2ggdXNlclxcJ3Mgb3duIGZ1bmRpbmcgcGFnZXMgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0Z1bmRpbmdQYWdlcyA9IFtcbiAgICAgICAgeyBpZDogJ2ZwLTEnLCB0aXRsZTogJ015IFByb2plY3QnLCB1c2VyX2lkOiAndGVzdC11c2VyLWF1dGhlZCcgfSxcbiAgICAgIF07XG4gICAgICBcbiAgICAgIGNvbnN0IHNlbGVjdE1vY2sgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBtb2NrRnVuZGluZ1BhZ2VzLCBlcnJvcjogbnVsbCB9KTtcbiAgICAgIG1vY2tTdXBhYmFzZUNsaWVudC5mcm9tLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAgICBlcTogc2VsZWN0TW9jaywgLy8gR0VUIGZvciB1c2VyJ3MgcGFnZXMgdXNlcyAuZXEoJ3VzZXJfaWQnLCB1c2VyLmlkKVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVybDogJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvZnVuZGluZycgfSBhcyBhbnk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IEdFVChyZXF1ZXN0KTtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChkYXRhLmZ1bmRpbmdQYWdlcykudG9FcXVhbChtb2NrRnVuZGluZ1BhZ2VzKTtcbiAgICAgIGV4cGVjdChtb2NrU3VwYWJhc2VDbGllbnQuZnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2Z1bmRpbmdfcGFnZXMnKTtcbiAgICAgIC8vIFRoZSBpbXBsZW1lbnRhdGlvbiBmb3JjZXMgZmlsdGVyaW5nIGJ5IGF1dGhlbnRpY2F0ZWQgdXNlclxuICAgICAgZXhwZWN0KHNlbGVjdE1vY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyX2lkJywgJ3Rlc3QtdXNlci1hdXRoZWQnKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCByZXR1cm4gNDAzIHdoZW4gdHJ5aW5nIHRvIGFjY2VzcyBhbm90aGVyIHVzZXJcXCdzIHBhZ2VzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0geyB1cmw6ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2Z1bmRpbmc/dXNlcklkPW90aGVyLXVzZXInIH0gYXMgYW55O1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IEdFVChyZXF1ZXN0KTtcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDAzKTtcbiAgICAgICAgZXhwZWN0KGRhdGEuZXJyb3IpLnRvQmUoJ0Nhbm5vdCBhY2Nlc3Mgb3RoZXIgdXNlcnNcXCcgZnVuZGluZyBkYXRhJyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgZmlsdGVyIGZ1bmRpbmcgcGFnZXMgYnkgc3RhdHVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBtb2NrQWN0aXZlRnVuZGluZ1BhZ2VzID0gW3sgaWQ6ICdmcC1hY3RpdmUnLCBzdGF0dXM6ICdhY3RpdmUnIH1dO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgZXFNb2NrU3RhdHVzID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogbW9ja0FjdGl2ZUZ1bmRpbmdQYWdlcywgZXJyb3I6IG51bGwgfSk7XG4gICAgICAgIGNvbnN0IGVxTW9ja1VzZXIgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgZXE6IGVxTW9ja1N0YXR1cyB9KTtcbiAgICAgICAgbW9ja1N1cGFiYXNlQ2xpZW50LmZyb20ubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICAgIHNlbGVjdDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgICAgICBlcTogZXFNb2NrVXNlcixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHsgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9mdW5kaW5nP3N0YXR1cz1hY3RpdmUnIH0gYXMgYW55O1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IEdFVChyZXF1ZXN0KTtcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgZXhwZWN0KGRhdGEuZnVuZGluZ1BhZ2VzKS50b0VxdWFsKG1vY2tBY3RpdmVGdW5kaW5nUGFnZXMpO1xuICAgICAgICBleHBlY3QoZXFNb2NrVXNlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXJfaWQnLCAndGVzdC11c2VyLWF1dGhlZCcpO1xuICAgICAgICBleHBlY3QoZXFNb2NrU3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnc3RhdHVzJywgJ2FjdGl2ZScpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSBkYXRhYmFzZSBlcnJvcnMgZ3JhY2VmdWxseSBkdXJpbmcgR0VUJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBtb2NrU3VwYWJhc2VDbGllbnQuZnJvbS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAgICAgIGVxOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiBudWxsLCBlcnJvcjogeyBtZXNzYWdlOiAnREIgRXJyb3InIH0gfSksXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHsgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9mdW5kaW5nJyB9IGFzIGFueTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBHRVQocmVxdWVzdCk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gIFxuICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDUwMCk7XG4gICAgICAgIGV4cGVjdChkYXRhLmVycm9yKS50b0JlKCdGYWlsZWQgdG8gZmV0Y2ggZnVuZGluZyBwYWdlcycpO1xuICAgIH0pO1xuXG4gIH0pO1xuXG4gIGRlc2NyaWJlKCfwn5OuIFBPU1QgL2FwaS9mdW5kaW5nIC0gVHJhbnNhY3Rpb24gQ3JlYXRpb24nLCAoKSA9PiB7XG5cbiAgICB0ZXN0KCdzaG91bGQgcmVxdWlyZSBhdXRoZW50aWNhdGlvbiB0byBjcmVhdGUgYSB0cmFuc2FjdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgbW9ja1N1cGFiYXNlQ2xpZW50LmF1dGguZ2V0VXNlci5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IHsgdXNlcjogbnVsbCB9LCBlcnJvcjogeyBtZXNzYWdlOiAnTm8gYXV0aCcgfSB9KTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBqc29uOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoe30pLFxuICAgICAgICAgICAgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9mdW5kaW5nJ1xuICAgICAgICB9IGFzIGFueTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBQT1NUKHJlcXVlc3QpO1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDAxKTtcbiAgICAgICAgZXhwZWN0KGRhdGEuZXJyb3IpLnRvQmUoJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkIHRvIGNyZWF0ZSB0cmFuc2FjdGlvbnMnKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCByZWplY3QgdHJhbnNhY3Rpb24gd2l0aCBtaXNzaW5nIGZpZWxkcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAganNvbjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgYW1vdW50OiAxMDAsIGN1cnJlbmN5OiAnQlRDJyB9KSwgLy8gbWlzc2luZyBmdW5kaW5nUGFnZUlkIGFuZCBwYXltZW50TWV0aG9kXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2Z1bmRpbmcnXG4gICAgICAgIH0gYXMgYW55O1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFBPU1QocmVxdWVzdCk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gIFxuICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQwMCk7XG4gICAgICAgIGV4cGVjdChkYXRhLmVycm9yKS50b0JlKCdBbGwgZmllbGRzIGFyZSByZXF1aXJlZCcpO1xuICAgIH0pO1xuICAgIFxuICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgYSB0cmFuc2FjdGlvbiBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIENsZWFyIGFsbCBwcmV2aW91cyBtb2NrcyBmb3IgdGhpcyBzcGVjaWZpYyB0ZXN0XG4gICAgICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuXG4gICAgICAgIGNvbnN0IGZ1bmRpbmdQYWdlSWQgPSAnZnAtb3duZWQtYnktdXNlcic7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uRGF0YSA9IHtcbiAgICAgICAgICAgIGZ1bmRpbmdQYWdlSWQsXG4gICAgICAgICAgICBhbW91bnQ6IDEwMDAsXG4gICAgICAgICAgICBjdXJyZW5jeTogJ3NhdHMnLFxuICAgICAgICAgICAgcGF5bWVudE1ldGhvZDogJ2xpZ2h0bmluZycsXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gUmVzZXQgdG8gZGVmYXVsdCBzdWNjZXNzZnVsIGF1dGggc3RhdGVcbiAgICAgICAgbW9ja1N1cGFiYXNlQ2xpZW50LmF1dGguZ2V0VXNlci5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgICAgICBkYXRhOiB7IHVzZXI6IHsgaWQ6ICd0ZXN0LXVzZXItYXV0aGVkJyB9IH0sXG4gICAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTW9jayBmdW5kaW5nIHBhZ2Ugb3duZXJzaGlwIGNoZWNrXG4gICAgICAgIG1vY2tTdXBhYmFzZUNsaWVudC5mcm9tLm1vY2tJbXBsZW1lbnRhdGlvbigodGFibGVOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGlmICh0YWJsZU5hbWUgPT09ICdmdW5kaW5nX3BhZ2VzJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgICAgICAgICAgICAgIGVxOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAgICAgICAgICAgICAgc2luZ2xlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogeyB1c2VyX2lkOiAndGVzdC11c2VyLWF1dGhlZCcsIHN0YXR1czogJ2FjdGl2ZScgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBudWxsXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGFibGVOYW1lID09PSAndHJhbnNhY3Rpb25zJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgICAgICAgICAgICAgIHNpbmdsZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogeyBpZDogJ25ldy10eC1pZCcsIC4uLnRyYW5zYWN0aW9uRGF0YSwgdXNlcl9pZDogJ3Rlc3QtdXNlci1hdXRoZWQnIH0sIGVycm9yOiBudWxsIH0pLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4geyBmcm9tOiBqZXN0LmZuKCkgfSBhcyBhbnk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGpzb246ICgpID0+IFByb21pc2UucmVzb2x2ZSh0cmFuc2FjdGlvbkRhdGEpLFxuICAgICAgICAgICAgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9mdW5kaW5nJ1xuICAgICAgICB9IGFzIGFueTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBQT1NUKHJlcXVlc3QpO1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgICBcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgICBleHBlY3QoZGF0YS5tZXNzYWdlKS50b0JlKCdUcmFuc2FjdGlvbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgICAgICBleHBlY3QoZGF0YS50cmFuc2FjdGlvbi5pZCkudG9CZSgnbmV3LXR4LWlkJyk7XG4gICAgfSk7XG4gICAgXG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSBkYXRhYmFzZSBpbnNlcnRpb24gZXJyb3JzIGR1cmluZyBQT1NUJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBtb2NrU3VwYWJhc2VDbGllbnQuZnJvbS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAgICAgIGVxOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBkYXRhOiB7IHVzZXJfaWQ6ICd0ZXN0LXVzZXItYXV0aGVkJywgc3RhdHVzOiAnYWN0aXZlJyB9LCBlcnJvcjogbnVsbCB9KSxcbiAgICAgICAgICAgIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgICAgICBzaW5nbGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6IG51bGwsIGVycm9yOiB7IG1lc3NhZ2U6ICdJbnNlcnQgZmFpbGVkJyB9IH0pLFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGpzb246ICgpID0+IFByb21pc2UucmVzb2x2ZSh7IGZ1bmRpbmdQYWdlSWQ6ICdmcC0xJywgYW1vdW50OiAxMDAsIGN1cnJlbmN5OiAnQlRDJywgcGF5bWVudE1ldGhvZDogJ2JpdGNvaW4nIH0pLFxuICAgICAgICAgICAgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9mdW5kaW5nJ1xuICAgICAgICB9IGFzIGFueTtcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFBPU1QocmVxdWVzdCk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gIFxuICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDUwMCk7XG4gICAgICAgIGV4cGVjdChkYXRhLmVycm9yKS50b0JlKCdGYWlsZWQgdG8gY3JlYXRlIHRyYW5zYWN0aW9uJyk7XG4gICAgfSk7XG5cbiAgfSk7XG59KTsgIl0sInZlcnNpb24iOjN9
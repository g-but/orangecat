e974d260a79f5641dfc03d8862aef18c
"use strict";
/**
 * SIMPLIFIED CAMPAIGN SERVICE TESTS - WORKING INFRASTRUCTURE
 *
 * This test suite focuses on core business logic with working mocks
 * Tests the most critical user flows for Bitcoin campaign platform
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock Supabase first
jest.mock('@supabase/ssr', () => ({
    createBrowserClient: jest.fn()
}));
const index_1 = require("../index");
describe('ðŸš€ CampaignService - Working Infrastructure Tests', () => {
    let campaignService;
    let mockSupabase;
    let localStorageMock;
    let mockInsert;
    let mockUpdate;
    const userId = 'test-user-123';
    const campaignId = 'campaign-456';
    const mockDbCampaign = {
        id: campaignId,
        user_id: userId,
        title: 'Test Campaign',
        description: 'Test Description',
        bitcoin_address: 'bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4',
        lightning_address: 'test@getalby.com',
        website_url: 'https://example.com',
        goal_amount: 50000,
        category: 'technology',
        tags: ['bitcoin'],
        currency: 'BTC',
        is_active: false,
        is_public: false,
        total_funding: 0,
        contributor_count: 0,
        created_at: '2024-01-01T00:00:00.000Z',
        updated_at: '2024-01-01T00:00:00.000Z'
    };
    const formData = {
        title: 'Test Campaign',
        description: 'Test Description',
        bitcoin_address: 'bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4',
        lightning_address: 'test@getalby.com',
        website_url: 'https://example.com',
        goal_amount: 50000,
        categories: ['technology', 'bitcoin']
    };
    beforeEach(() => {
        jest.clearAllMocks();
        // Setup localStorage mock
        localStorageMock = {};
        Storage.prototype.getItem = jest.fn((key) => localStorageMock[key] || null);
        Storage.prototype.setItem = jest.fn((key, value) => {
            localStorageMock[key] = value;
        });
        Storage.prototype.removeItem = jest.fn((key) => {
            delete localStorageMock[key];
        });
        // Create mock functions that we can track
        mockInsert = jest.fn(() => ({
            select: jest.fn(() => ({
                single: jest.fn(() => Promise.resolve({ data: mockDbCampaign, error: null }))
            }))
        }));
        mockUpdate = jest.fn(() => ({
            eq: jest.fn(() => ({
                eq: jest.fn(() => ({
                    select: jest.fn(() => ({
                        single: jest.fn(() => Promise.resolve({ data: Object.assign(Object.assign({}, mockDbCampaign), { is_active: true, is_public: true }), error: null }))
                    }))
                }))
            }))
        }));
        // Setup mock Supabase with working chains
        mockSupabase = {
            from: jest.fn(() => ({
                select: jest.fn(() => ({
                    eq: jest.fn(() => ({
                        order: jest.fn(() => Promise.resolve({ data: [mockDbCampaign], error: null })),
                        single: jest.fn(() => Promise.resolve({ data: mockDbCampaign, error: null }))
                    }))
                })),
                insert: mockInsert,
                update: mockUpdate
            }))
        };
        campaignService = new index_1.CampaignService(mockSupabase);
    });
    describe('ðŸ“Š Core Campaign Loading', () => {
        it('should load campaigns successfully', async () => {
            const campaigns = await campaignService.getAllCampaigns(userId);
            expect(campaigns).toHaveLength(1);
            expect(campaigns[0].title).toBe('Test Campaign');
            expect(campaigns[0].source).toBe('database');
            expect(campaigns[0].isDraft).toBe(true); // is_active: false, is_public: false
            expect(mockSupabase.from).toHaveBeenCalledWith('funding_pages');
        });
        it('should handle database errors', async () => {
            // Setup error mock
            mockSupabase.from.mockReturnValue({
                select: jest.fn(() => ({
                    eq: jest.fn(() => ({
                        order: jest.fn(() => Promise.resolve({ data: null, error: new Error('Database error') }))
                    }))
                }))
            });
            await expect(campaignService.getAllCampaigns(userId)).rejects.toThrow('Database error');
        });
        it('should merge local drafts with database campaigns', async () => {
            // Set up local draft
            localStorageMock[`funding-draft-${userId}`] = JSON.stringify({
                formData: { title: 'Local Draft', description: 'Local description' },
                currentStep: 2,
                draftId: campaignId,
                lastSaved: new Date().toISOString()
            });
            const campaigns = await campaignService.getAllCampaigns(userId);
            // Should use local data over database
            expect(campaigns).toHaveLength(1);
            expect(campaigns[0].title).toBe('Local Draft');
            expect(campaigns[0].source).toBe('local');
        });
    });
    describe('ðŸ’¾ Draft Management', () => {
        it('should save draft locally and to database', async () => {
            const draftId = await campaignService.saveDraft(userId, formData, 1);
            // Check database was called
            expect(mockSupabase.from).toHaveBeenCalledWith('funding_pages');
            expect(draftId).toBe(campaignId);
            // Check localStorage was updated
            expect(Storage.prototype.setItem).toHaveBeenCalled();
            const savedData = JSON.parse(localStorageMock[`funding-draft-${userId}`]);
            expect(savedData.formData.title).toBe(formData.title);
        });
        it('should handle malformed data gracefully', async () => {
            const malformedData = Object.assign(Object.assign({}, formData), { goal_amount: 'invalid-number' });
            // This should not throw an error
            await expect(campaignService.saveDraft(userId, malformedData, 1)).resolves.toBeDefined();
            expect(mockInsert).toHaveBeenCalledWith(expect.objectContaining({
                goal_amount: null // Should convert invalid numbers to null
            }));
        });
    });
    describe('ðŸš€ Campaign Publishing', () => {
        it('should publish campaign successfully', async () => {
            const publishedCampaign = await campaignService.publishCampaign(userId, campaignId, formData);
            expect(publishedCampaign.isActive).toBe(true);
            expect(publishedCampaign.isDraft).toBe(false);
            expect(mockSupabase.from).toHaveBeenCalledWith('funding_pages');
        });
        it('should clear local draft after publish', async () => {
            // Set up local draft
            localStorageMock[`funding-draft-${userId}`] = JSON.stringify({ formData });
            await campaignService.publishCampaign(userId, campaignId, formData);
            // Local draft should be cleared
            expect(localStorageMock[`funding-draft-${userId}`]).toBeUndefined();
        });
    });
    describe('ðŸ” Campaign Filtering', () => {
        it('should filter campaigns by status', async () => {
            const campaigns = [
                Object.assign(Object.assign({}, mockDbCampaign), { id: '1', is_active: false, is_public: false, isDraft: true, isActive: false, isPaused: false, source: 'database' }),
                Object.assign(Object.assign({}, mockDbCampaign), { id: '2', is_active: true, is_public: true, isDraft: false, isActive: true, isPaused: false, source: 'database' }),
                Object.assign(Object.assign({}, mockDbCampaign), { id: '3', is_active: false, is_public: true, isDraft: false, isActive: false, isPaused: true, source: 'database' })
            ];
            const drafts = await campaignService.filterCampaigns(campaigns, { status: 'draft' });
            const active = await campaignService.filterCampaigns(campaigns, { status: 'active' });
            const paused = await campaignService.filterCampaigns(campaigns, { status: 'paused' });
            expect(drafts).toHaveLength(1);
            expect(active).toHaveLength(1);
            expect(paused).toHaveLength(1);
            expect(drafts[0].isDraft).toBe(true);
            expect(active[0].isActive).toBe(true);
            expect(paused[0].isPaused).toBe(true);
        });
    });
    describe('ðŸ› ï¸ Local Storage Management', () => {
        it('should detect local draft existence', () => {
            localStorageMock[`funding-draft-${userId}`] = JSON.stringify({ formData });
            const hasLocalDraft = campaignService.hasLocalDraft(userId);
            expect(hasLocalDraft).toBe(true);
        });
        it('should retrieve local draft correctly', () => {
            const draftData = { formData, currentStep: 2 };
            localStorageMock[`funding-draft-${userId}`] = JSON.stringify(draftData);
            const localDraft = campaignService.getLocalDraft(userId);
            expect(localDraft).toBeTruthy();
            expect(localDraft === null || localDraft === void 0 ? void 0 : localDraft.formData.title).toBe(formData.title);
            expect(localDraft === null || localDraft === void 0 ? void 0 : localDraft.currentStep).toBe(2);
        });
        it('should clear local draft completely', () => {
            localStorageMock[`funding-draft-${userId}`] = JSON.stringify({ formData });
            campaignService.clearLocalDraft(userId);
            expect(localStorageMock[`funding-draft-${userId}`]).toBeUndefined();
        });
        it('should handle corrupted localStorage gracefully', () => {
            localStorageMock[`funding-draft-${userId}`] = 'invalid-json-data';
            const localDraft = campaignService.getLocalDraft(userId);
            expect(localDraft).toBe(null);
        });
    });
    describe('âš ï¸ Error Handling', () => {
        it('should handle empty user ID', async () => {
            await expect(campaignService.getAllCampaigns('')).rejects.toThrow('User ID is required');
        });
        it('should handle null form data', async () => {
            await expect(campaignService.saveDraft(userId, null, 1)).rejects.toThrow('Form data is required');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9zZXJ2aWNlcy9jYW1wYWlnbnMvX190ZXN0c19fL2NhbXBhaWduU2VydmljZS5zaW1wbGUudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7O0FBRUgsc0JBQXNCO0FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDaEMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUMvQixDQUFDLENBQUMsQ0FBQTtBQUVILG9DQUEwQztBQUUxQyxRQUFRLENBQUMsbURBQW1ELEVBQUUsR0FBRyxFQUFFO0lBQ2pFLElBQUksZUFBZ0MsQ0FBQTtJQUNwQyxJQUFJLFlBQWlCLENBQUE7SUFDckIsSUFBSSxnQkFBd0MsQ0FBQTtJQUM1QyxJQUFJLFVBQXFCLENBQUE7SUFDekIsSUFBSSxVQUFxQixDQUFBO0lBRXpCLE1BQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQTtJQUM5QixNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUE7SUFFakMsTUFBTSxjQUFjLEdBQUc7UUFDckIsRUFBRSxFQUFFLFVBQVU7UUFDZCxPQUFPLEVBQUUsTUFBTTtRQUNmLEtBQUssRUFBRSxlQUFlO1FBQ3RCLFdBQVcsRUFBRSxrQkFBa0I7UUFDL0IsZUFBZSxFQUFFLDRDQUE0QztRQUM3RCxpQkFBaUIsRUFBRSxrQkFBa0I7UUFDckMsV0FBVyxFQUFFLHFCQUFxQjtRQUNsQyxXQUFXLEVBQUUsS0FBSztRQUNsQixRQUFRLEVBQUUsWUFBWTtRQUN0QixJQUFJLEVBQUUsQ0FBQyxTQUFTLENBQUM7UUFDakIsUUFBUSxFQUFFLEtBQUs7UUFDZixTQUFTLEVBQUUsS0FBSztRQUNoQixTQUFTLEVBQUUsS0FBSztRQUNoQixhQUFhLEVBQUUsQ0FBQztRQUNoQixpQkFBaUIsRUFBRSxDQUFDO1FBQ3BCLFVBQVUsRUFBRSwwQkFBMEI7UUFDdEMsVUFBVSxFQUFFLDBCQUEwQjtLQUN2QyxDQUFBO0lBRUQsTUFBTSxRQUFRLEdBQUc7UUFDZixLQUFLLEVBQUUsZUFBZTtRQUN0QixXQUFXLEVBQUUsa0JBQWtCO1FBQy9CLGVBQWUsRUFBRSw0Q0FBNEM7UUFDN0QsaUJBQWlCLEVBQUUsa0JBQWtCO1FBQ3JDLFdBQVcsRUFBRSxxQkFBcUI7UUFDbEMsV0FBVyxFQUFFLEtBQUs7UUFDbEIsVUFBVSxFQUFFLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQztLQUN0QyxDQUFBO0lBRUQsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUVwQiwwQkFBMEI7UUFDMUIsZ0JBQWdCLEdBQUcsRUFBRSxDQUFBO1FBQ3JCLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFBO1FBQzNFLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDakQsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFBO1FBQy9CLENBQUMsQ0FBQyxDQUFBO1FBQ0YsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQzdDLE9BQU8sZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDOUIsQ0FBQyxDQUFDLENBQUE7UUFFRiwwQ0FBMEM7UUFDMUMsVUFBVSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUMxQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUM5RSxDQUFDLENBQUM7U0FDSixDQUFDLENBQUMsQ0FBQTtRQUVILFVBQVUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDMUIsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDakIsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDakIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksa0NBQU0sY0FBYyxLQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksR0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO3FCQUNySCxDQUFDLENBQUM7aUJBQ0osQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFDO1NBQ0osQ0FBQyxDQUFDLENBQUE7UUFFSCwwQ0FBMEM7UUFDMUMsWUFBWSxHQUFHO1lBQ2IsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDckIsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLGNBQWMsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO3dCQUM5RSxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztxQkFDOUUsQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQztnQkFDSCxNQUFNLEVBQUUsVUFBVTtnQkFDbEIsTUFBTSxFQUFFLFVBQVU7YUFDbkIsQ0FBQyxDQUFDO1NBQ0osQ0FBQTtRQUVELGVBQWUsR0FBRyxJQUFJLHVCQUFlLENBQUMsWUFBWSxDQUFDLENBQUE7SUFDckQsQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO1FBQ3hDLEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRCxNQUFNLFNBQVMsR0FBRyxNQUFNLGVBQWUsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUE7WUFFL0QsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNqQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQUNoRCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUM1QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFDLHFDQUFxQztZQUM3RSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGVBQWUsQ0FBQyxDQUFBO1FBQ2pFLENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLCtCQUErQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzdDLG1CQUFtQjtZQUNuQixZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztnQkFDaEMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDckIsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUMxRixDQUFDLENBQUM7aUJBQ0osQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFBO1lBRUYsTUFBTSxNQUFNLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtRQUN6RixDQUFDLENBQUMsQ0FBQTtRQUVGLEVBQUUsQ0FBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRSxxQkFBcUI7WUFDckIsZ0JBQWdCLENBQUMsaUJBQWlCLE1BQU0sRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDM0QsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUU7Z0JBQ3BFLFdBQVcsRUFBRSxDQUFDO2dCQUNkLE9BQU8sRUFBRSxVQUFVO2dCQUNuQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDcEMsQ0FBQyxDQUFBO1lBRUYsTUFBTSxTQUFTLEdBQUcsTUFBTSxlQUFlLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBRS9ELHNDQUFzQztZQUN0QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ2pDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1lBQzlDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQzNDLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLEVBQUUsQ0FBQywyQ0FBMkMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN6RCxNQUFNLE9BQU8sR0FBRyxNQUFNLGVBQWUsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUVwRSw0QkFBNEI7WUFDNUIsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQUMvRCxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBRWhDLGlDQUFpQztZQUNqQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1lBQ3BELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUN6RSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3ZELENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3ZELE1BQU0sYUFBYSxtQ0FDZCxRQUFRLEtBQ1gsV0FBVyxFQUFFLGdCQUF1QixHQUNyQyxDQUFBO1lBRUQsaUNBQWlDO1lBQ2pDLE1BQU0sTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtZQUV4RixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsb0JBQW9CLENBQ3JDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsV0FBVyxFQUFFLElBQUksQ0FBQyx5Q0FBeUM7YUFDNUQsQ0FBQyxDQUNILENBQUE7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtRQUN0QyxFQUFFLENBQUMsc0NBQXNDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDcEQsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLGVBQWUsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQTtZQUU3RixNQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQzdDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDN0MsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUNqRSxDQUFDLENBQUMsQ0FBQTtRQUVGLEVBQUUsQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN0RCxxQkFBcUI7WUFDckIsZ0JBQWdCLENBQUMsaUJBQWlCLE1BQU0sRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7WUFFMUUsTUFBTSxlQUFlLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUE7WUFFbkUsZ0NBQWdDO1lBQ2hDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxpQkFBaUIsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3JFLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO1FBQ3JDLEVBQUUsQ0FBQyxtQ0FBbUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRCxNQUFNLFNBQVMsR0FBRztnREFDWCxjQUFjLEtBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFVBQW1CO2dEQUN6SSxjQUFjLEtBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFVBQW1CO2dEQUN2SSxjQUFjLEtBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFVBQW1CO2FBQzlJLENBQUE7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLGVBQWUsQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7WUFDcEYsTUFBTSxNQUFNLEdBQUcsTUFBTSxlQUFlLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFBO1lBQ3JGLE1BQU0sTUFBTSxHQUFHLE1BQU0sZUFBZSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtZQUVyRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQzlCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDOUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUM5QixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNwQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN2QyxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtRQUM1QyxFQUFFLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFO1lBQzdDLGdCQUFnQixDQUFDLGlCQUFpQixNQUFNLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFBO1lBRTFFLE1BQU0sYUFBYSxHQUFHLGVBQWUsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDM0QsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNsQyxDQUFDLENBQUMsQ0FBQTtRQUVGLEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7WUFDL0MsTUFBTSxTQUFTLEdBQUcsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxDQUFBO1lBQzlDLGdCQUFnQixDQUFDLGlCQUFpQixNQUFNLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUE7WUFFdkUsTUFBTSxVQUFVLEdBQUcsZUFBZSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUN4RCxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDL0IsTUFBTSxDQUFDLFVBQVUsYUFBVixVQUFVLHVCQUFWLFVBQVUsQ0FBRSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUN2RCxNQUFNLENBQUMsVUFBVSxhQUFWLFVBQVUsdUJBQVYsVUFBVSxDQUFFLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN6QyxDQUFDLENBQUMsQ0FBQTtRQUVGLEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUU7WUFDN0MsZ0JBQWdCLENBQUMsaUJBQWlCLE1BQU0sRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7WUFFMUUsZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUN2QyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUNyRSxDQUFDLENBQUMsQ0FBQTtRQUVGLEVBQUUsQ0FBQyxpREFBaUQsRUFBRSxHQUFHLEVBQUU7WUFDekQsZ0JBQWdCLENBQUMsaUJBQWlCLE1BQU0sRUFBRSxDQUFDLEdBQUcsbUJBQW1CLENBQUE7WUFFakUsTUFBTSxVQUFVLEdBQUcsZUFBZSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUN4RCxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQy9CLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2pDLEVBQUUsQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMzQyxNQUFNLE1BQU0sQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO1FBQzFGLENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLDhCQUE4QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzVDLE1BQU0sTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLElBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQTtRQUMxRyxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9zZXJ2aWNlcy9jYW1wYWlnbnMvX190ZXN0c19fL2NhbXBhaWduU2VydmljZS5zaW1wbGUudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNJTVBMSUZJRUQgQ0FNUEFJR04gU0VSVklDRSBURVNUUyAtIFdPUktJTkcgSU5GUkFTVFJVQ1RVUkVcbiAqIFxuICogVGhpcyB0ZXN0IHN1aXRlIGZvY3VzZXMgb24gY29yZSBidXNpbmVzcyBsb2dpYyB3aXRoIHdvcmtpbmcgbW9ja3NcbiAqIFRlc3RzIHRoZSBtb3N0IGNyaXRpY2FsIHVzZXIgZmxvd3MgZm9yIEJpdGNvaW4gY2FtcGFpZ24gcGxhdGZvcm1cbiAqL1xuXG4vLyBNb2NrIFN1cGFiYXNlIGZpcnN0XG5qZXN0Lm1vY2soJ0BzdXBhYmFzZS9zc3InLCAoKSA9PiAoe1xuICBjcmVhdGVCcm93c2VyQ2xpZW50OiBqZXN0LmZuKClcbn0pKVxuXG5pbXBvcnQgeyBDYW1wYWlnblNlcnZpY2UgfSBmcm9tICcuLi9pbmRleCdcblxuZGVzY3JpYmUoJ/CfmoAgQ2FtcGFpZ25TZXJ2aWNlIC0gV29ya2luZyBJbmZyYXN0cnVjdHVyZSBUZXN0cycsICgpID0+IHtcbiAgbGV0IGNhbXBhaWduU2VydmljZTogQ2FtcGFpZ25TZXJ2aWNlXG4gIGxldCBtb2NrU3VwYWJhc2U6IGFueVxuICBsZXQgbG9jYWxTdG9yYWdlTW9jazogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICBsZXQgbW9ja0luc2VydDogamVzdC5Nb2NrXG4gIGxldCBtb2NrVXBkYXRlOiBqZXN0Lk1vY2tcblxuICBjb25zdCB1c2VySWQgPSAndGVzdC11c2VyLTEyMydcbiAgY29uc3QgY2FtcGFpZ25JZCA9ICdjYW1wYWlnbi00NTYnXG4gIFxuICBjb25zdCBtb2NrRGJDYW1wYWlnbiA9IHtcbiAgICBpZDogY2FtcGFpZ25JZCxcbiAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgdGl0bGU6ICdUZXN0IENhbXBhaWduJyxcbiAgICBkZXNjcmlwdGlvbjogJ1Rlc3QgRGVzY3JpcHRpb24nLFxuICAgIGJpdGNvaW5fYWRkcmVzczogJ2JjMXF3NTA4ZDZxZWp4dGRnNHk1cjN6YXJ2YXJ5MGM1eHc3a3Y4ZjN0NCcsXG4gICAgbGlnaHRuaW5nX2FkZHJlc3M6ICd0ZXN0QGdldGFsYnkuY29tJyxcbiAgICB3ZWJzaXRlX3VybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20nLFxuICAgIGdvYWxfYW1vdW50OiA1MDAwMCxcbiAgICBjYXRlZ29yeTogJ3RlY2hub2xvZ3knLFxuICAgIHRhZ3M6IFsnYml0Y29pbiddLFxuICAgIGN1cnJlbmN5OiAnQlRDJyxcbiAgICBpc19hY3RpdmU6IGZhbHNlLFxuICAgIGlzX3B1YmxpYzogZmFsc2UsXG4gICAgdG90YWxfZnVuZGluZzogMCxcbiAgICBjb250cmlidXRvcl9jb3VudDogMCxcbiAgICBjcmVhdGVkX2F0OiAnMjAyNC0wMS0wMVQwMDowMDowMC4wMDBaJyxcbiAgICB1cGRhdGVkX2F0OiAnMjAyNC0wMS0wMVQwMDowMDowMC4wMDBaJ1xuICB9XG5cbiAgY29uc3QgZm9ybURhdGEgPSB7XG4gICAgdGl0bGU6ICdUZXN0IENhbXBhaWduJyxcbiAgICBkZXNjcmlwdGlvbjogJ1Rlc3QgRGVzY3JpcHRpb24nLFxuICAgIGJpdGNvaW5fYWRkcmVzczogJ2JjMXF3NTA4ZDZxZWp4dGRnNHk1cjN6YXJ2YXJ5MGM1eHc3a3Y4ZjN0NCcsXG4gICAgbGlnaHRuaW5nX2FkZHJlc3M6ICd0ZXN0QGdldGFsYnkuY29tJyxcbiAgICB3ZWJzaXRlX3VybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20nLFxuICAgIGdvYWxfYW1vdW50OiA1MDAwMCxcbiAgICBjYXRlZ29yaWVzOiBbJ3RlY2hub2xvZ3knLCAnYml0Y29pbiddXG4gIH1cblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuICAgIFxuICAgIC8vIFNldHVwIGxvY2FsU3RvcmFnZSBtb2NrXG4gICAgbG9jYWxTdG9yYWdlTW9jayA9IHt9XG4gICAgU3RvcmFnZS5wcm90b3R5cGUuZ2V0SXRlbSA9IGplc3QuZm4oKGtleSkgPT4gbG9jYWxTdG9yYWdlTW9ja1trZXldIHx8IG51bGwpXG4gICAgU3RvcmFnZS5wcm90b3R5cGUuc2V0SXRlbSA9IGplc3QuZm4oKGtleSwgdmFsdWUpID0+IHtcbiAgICAgIGxvY2FsU3RvcmFnZU1vY2tba2V5XSA9IHZhbHVlXG4gICAgfSlcbiAgICBTdG9yYWdlLnByb3RvdHlwZS5yZW1vdmVJdGVtID0gamVzdC5mbigoa2V5KSA9PiB7XG4gICAgICBkZWxldGUgbG9jYWxTdG9yYWdlTW9ja1trZXldXG4gICAgfSlcblxuICAgIC8vIENyZWF0ZSBtb2NrIGZ1bmN0aW9ucyB0aGF0IHdlIGNhbiB0cmFja1xuICAgIG1vY2tJbnNlcnQgPSBqZXN0LmZuKCgpID0+ICh7XG4gICAgICBzZWxlY3Q6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgc2luZ2xlOiBqZXN0LmZuKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IG1vY2tEYkNhbXBhaWduLCBlcnJvcjogbnVsbCB9KSlcbiAgICAgIH0pKVxuICAgIH0pKVxuXG4gICAgbW9ja1VwZGF0ZSA9IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgIGVxOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIGVxOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgICAgc2VsZWN0OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgICAgICBzaW5nbGU6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogey4uLm1vY2tEYkNhbXBhaWduLCBpc19hY3RpdmU6IHRydWUsIGlzX3B1YmxpYzogdHJ1ZX0sIGVycm9yOiBudWxsIH0pKVxuICAgICAgICAgIH0pKVxuICAgICAgICB9KSlcbiAgICAgIH0pKVxuICAgIH0pKVxuXG4gICAgLy8gU2V0dXAgbW9jayBTdXBhYmFzZSB3aXRoIHdvcmtpbmcgY2hhaW5zXG4gICAgbW9ja1N1cGFiYXNlID0ge1xuICAgICAgZnJvbTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICAgICAgb3JkZXI6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogW21vY2tEYkNhbXBhaWduXSwgZXJyb3I6IG51bGwgfSkpLFxuICAgICAgICAgICAgc2luZ2xlOiBqZXN0LmZuKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IG1vY2tEYkNhbXBhaWduLCBlcnJvcjogbnVsbCB9KSlcbiAgICAgICAgICB9KSlcbiAgICAgICAgfSkpLFxuICAgICAgICBpbnNlcnQ6IG1vY2tJbnNlcnQsXG4gICAgICAgIHVwZGF0ZTogbW9ja1VwZGF0ZVxuICAgICAgfSkpXG4gICAgfVxuXG4gICAgY2FtcGFpZ25TZXJ2aWNlID0gbmV3IENhbXBhaWduU2VydmljZShtb2NrU3VwYWJhc2UpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ/Cfk4ogQ29yZSBDYW1wYWlnbiBMb2FkaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbG9hZCBjYW1wYWlnbnMgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY2FtcGFpZ25zID0gYXdhaXQgY2FtcGFpZ25TZXJ2aWNlLmdldEFsbENhbXBhaWducyh1c2VySWQpXG5cbiAgICAgIGV4cGVjdChjYW1wYWlnbnMpLnRvSGF2ZUxlbmd0aCgxKVxuICAgICAgZXhwZWN0KGNhbXBhaWduc1swXS50aXRsZSkudG9CZSgnVGVzdCBDYW1wYWlnbicpXG4gICAgICBleHBlY3QoY2FtcGFpZ25zWzBdLnNvdXJjZSkudG9CZSgnZGF0YWJhc2UnKVxuICAgICAgZXhwZWN0KGNhbXBhaWduc1swXS5pc0RyYWZ0KS50b0JlKHRydWUpIC8vIGlzX2FjdGl2ZTogZmFsc2UsIGlzX3B1YmxpYzogZmFsc2VcbiAgICAgIGV4cGVjdChtb2NrU3VwYWJhc2UuZnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2Z1bmRpbmdfcGFnZXMnKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBkYXRhYmFzZSBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTZXR1cCBlcnJvciBtb2NrXG4gICAgICBtb2NrU3VwYWJhc2UuZnJvbS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgICBlcTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICAgICAgb3JkZXI6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogbnVsbCwgZXJyb3I6IG5ldyBFcnJvcignRGF0YWJhc2UgZXJyb3InKSB9KSlcbiAgICAgICAgICB9KSlcbiAgICAgICAgfSkpXG4gICAgICB9KVxuXG4gICAgICBhd2FpdCBleHBlY3QoY2FtcGFpZ25TZXJ2aWNlLmdldEFsbENhbXBhaWducyh1c2VySWQpKS5yZWplY3RzLnRvVGhyb3coJ0RhdGFiYXNlIGVycm9yJylcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBtZXJnZSBsb2NhbCBkcmFmdHMgd2l0aCBkYXRhYmFzZSBjYW1wYWlnbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTZXQgdXAgbG9jYWwgZHJhZnRcbiAgICAgIGxvY2FsU3RvcmFnZU1vY2tbYGZ1bmRpbmctZHJhZnQtJHt1c2VySWR9YF0gPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGZvcm1EYXRhOiB7IHRpdGxlOiAnTG9jYWwgRHJhZnQnLCBkZXNjcmlwdGlvbjogJ0xvY2FsIGRlc2NyaXB0aW9uJyB9LFxuICAgICAgICBjdXJyZW50U3RlcDogMixcbiAgICAgICAgZHJhZnRJZDogY2FtcGFpZ25JZCxcbiAgICAgICAgbGFzdFNhdmVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IGNhbXBhaWducyA9IGF3YWl0IGNhbXBhaWduU2VydmljZS5nZXRBbGxDYW1wYWlnbnModXNlcklkKVxuXG4gICAgICAvLyBTaG91bGQgdXNlIGxvY2FsIGRhdGEgb3ZlciBkYXRhYmFzZVxuICAgICAgZXhwZWN0KGNhbXBhaWducykudG9IYXZlTGVuZ3RoKDEpXG4gICAgICBleHBlY3QoY2FtcGFpZ25zWzBdLnRpdGxlKS50b0JlKCdMb2NhbCBEcmFmdCcpXG4gICAgICBleHBlY3QoY2FtcGFpZ25zWzBdLnNvdXJjZSkudG9CZSgnbG9jYWwnKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ/Cfkr4gRHJhZnQgTWFuYWdlbWVudCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNhdmUgZHJhZnQgbG9jYWxseSBhbmQgdG8gZGF0YWJhc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkcmFmdElkID0gYXdhaXQgY2FtcGFpZ25TZXJ2aWNlLnNhdmVEcmFmdCh1c2VySWQsIGZvcm1EYXRhLCAxKVxuXG4gICAgICAvLyBDaGVjayBkYXRhYmFzZSB3YXMgY2FsbGVkXG4gICAgICBleHBlY3QobW9ja1N1cGFiYXNlLmZyb20pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdmdW5kaW5nX3BhZ2VzJylcbiAgICAgIGV4cGVjdChkcmFmdElkKS50b0JlKGNhbXBhaWduSWQpXG4gICAgICBcbiAgICAgIC8vIENoZWNrIGxvY2FsU3RvcmFnZSB3YXMgdXBkYXRlZFxuICAgICAgZXhwZWN0KFN0b3JhZ2UucHJvdG90eXBlLnNldEl0ZW0pLnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgY29uc3Qgc2F2ZWREYXRhID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2VNb2NrW2BmdW5kaW5nLWRyYWZ0LSR7dXNlcklkfWBdKVxuICAgICAgZXhwZWN0KHNhdmVkRGF0YS5mb3JtRGF0YS50aXRsZSkudG9CZShmb3JtRGF0YS50aXRsZSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWFsZm9ybWVkIGRhdGEgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1hbGZvcm1lZERhdGEgPSB7XG4gICAgICAgIC4uLmZvcm1EYXRhLFxuICAgICAgICBnb2FsX2Ftb3VudDogJ2ludmFsaWQtbnVtYmVyJyBhcyBhbnlcbiAgICAgIH1cblxuICAgICAgLy8gVGhpcyBzaG91bGQgbm90IHRocm93IGFuIGVycm9yXG4gICAgICBhd2FpdCBleHBlY3QoY2FtcGFpZ25TZXJ2aWNlLnNhdmVEcmFmdCh1c2VySWQsIG1hbGZvcm1lZERhdGEsIDEpKS5yZXNvbHZlcy50b0JlRGVmaW5lZCgpXG5cbiAgICAgIGV4cGVjdChtb2NrSW5zZXJ0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGdvYWxfYW1vdW50OiBudWxsIC8vIFNob3VsZCBjb252ZXJ0IGludmFsaWQgbnVtYmVycyB0byBudWxsXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgn8J+agCBDYW1wYWlnbiBQdWJsaXNoaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcHVibGlzaCBjYW1wYWlnbiBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwdWJsaXNoZWRDYW1wYWlnbiA9IGF3YWl0IGNhbXBhaWduU2VydmljZS5wdWJsaXNoQ2FtcGFpZ24odXNlcklkLCBjYW1wYWlnbklkLCBmb3JtRGF0YSlcblxuICAgICAgZXhwZWN0KHB1Ymxpc2hlZENhbXBhaWduLmlzQWN0aXZlKS50b0JlKHRydWUpXG4gICAgICBleHBlY3QocHVibGlzaGVkQ2FtcGFpZ24uaXNEcmFmdCkudG9CZShmYWxzZSlcbiAgICAgIGV4cGVjdChtb2NrU3VwYWJhc2UuZnJvbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2Z1bmRpbmdfcGFnZXMnKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGNsZWFyIGxvY2FsIGRyYWZ0IGFmdGVyIHB1Ymxpc2gnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTZXQgdXAgbG9jYWwgZHJhZnRcbiAgICAgIGxvY2FsU3RvcmFnZU1vY2tbYGZ1bmRpbmctZHJhZnQtJHt1c2VySWR9YF0gPSBKU09OLnN0cmluZ2lmeSh7IGZvcm1EYXRhIH0pXG5cbiAgICAgIGF3YWl0IGNhbXBhaWduU2VydmljZS5wdWJsaXNoQ2FtcGFpZ24odXNlcklkLCBjYW1wYWlnbklkLCBmb3JtRGF0YSlcblxuICAgICAgLy8gTG9jYWwgZHJhZnQgc2hvdWxkIGJlIGNsZWFyZWRcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2VNb2NrW2BmdW5kaW5nLWRyYWZ0LSR7dXNlcklkfWBdKS50b0JlVW5kZWZpbmVkKClcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCfwn5SNIENhbXBhaWduIEZpbHRlcmluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGZpbHRlciBjYW1wYWlnbnMgYnkgc3RhdHVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY2FtcGFpZ25zID0gW1xuICAgICAgICB7IC4uLm1vY2tEYkNhbXBhaWduLCBpZDogJzEnLCBpc19hY3RpdmU6IGZhbHNlLCBpc19wdWJsaWM6IGZhbHNlLCBpc0RyYWZ0OiB0cnVlLCBpc0FjdGl2ZTogZmFsc2UsIGlzUGF1c2VkOiBmYWxzZSwgc291cmNlOiAnZGF0YWJhc2UnIGFzIGNvbnN0IH0sXG4gICAgICAgIHsgLi4ubW9ja0RiQ2FtcGFpZ24sIGlkOiAnMicsIGlzX2FjdGl2ZTogdHJ1ZSwgaXNfcHVibGljOiB0cnVlLCBpc0RyYWZ0OiBmYWxzZSwgaXNBY3RpdmU6IHRydWUsIGlzUGF1c2VkOiBmYWxzZSwgc291cmNlOiAnZGF0YWJhc2UnIGFzIGNvbnN0IH0sXG4gICAgICAgIHsgLi4ubW9ja0RiQ2FtcGFpZ24sIGlkOiAnMycsIGlzX2FjdGl2ZTogZmFsc2UsIGlzX3B1YmxpYzogdHJ1ZSwgaXNEcmFmdDogZmFsc2UsIGlzQWN0aXZlOiBmYWxzZSwgaXNQYXVzZWQ6IHRydWUsIHNvdXJjZTogJ2RhdGFiYXNlJyBhcyBjb25zdCB9XG4gICAgICBdXG5cbiAgICAgIGNvbnN0IGRyYWZ0cyA9IGF3YWl0IGNhbXBhaWduU2VydmljZS5maWx0ZXJDYW1wYWlnbnMoY2FtcGFpZ25zLCB7IHN0YXR1czogJ2RyYWZ0JyB9KVxuICAgICAgY29uc3QgYWN0aXZlID0gYXdhaXQgY2FtcGFpZ25TZXJ2aWNlLmZpbHRlckNhbXBhaWducyhjYW1wYWlnbnMsIHsgc3RhdHVzOiAnYWN0aXZlJyB9KVxuICAgICAgY29uc3QgcGF1c2VkID0gYXdhaXQgY2FtcGFpZ25TZXJ2aWNlLmZpbHRlckNhbXBhaWducyhjYW1wYWlnbnMsIHsgc3RhdHVzOiAncGF1c2VkJyB9KVxuXG4gICAgICBleHBlY3QoZHJhZnRzKS50b0hhdmVMZW5ndGgoMSlcbiAgICAgIGV4cGVjdChhY3RpdmUpLnRvSGF2ZUxlbmd0aCgxKVxuICAgICAgZXhwZWN0KHBhdXNlZCkudG9IYXZlTGVuZ3RoKDEpXG4gICAgICBleHBlY3QoZHJhZnRzWzBdLmlzRHJhZnQpLnRvQmUodHJ1ZSlcbiAgICAgIGV4cGVjdChhY3RpdmVbMF0uaXNBY3RpdmUpLnRvQmUodHJ1ZSlcbiAgICAgIGV4cGVjdChwYXVzZWRbMF0uaXNQYXVzZWQpLnRvQmUodHJ1ZSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCfwn5ug77iPIExvY2FsIFN0b3JhZ2UgTWFuYWdlbWVudCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRldGVjdCBsb2NhbCBkcmFmdCBleGlzdGVuY2UnLCAoKSA9PiB7XG4gICAgICBsb2NhbFN0b3JhZ2VNb2NrW2BmdW5kaW5nLWRyYWZ0LSR7dXNlcklkfWBdID0gSlNPTi5zdHJpbmdpZnkoeyBmb3JtRGF0YSB9KVxuXG4gICAgICBjb25zdCBoYXNMb2NhbERyYWZ0ID0gY2FtcGFpZ25TZXJ2aWNlLmhhc0xvY2FsRHJhZnQodXNlcklkKVxuICAgICAgZXhwZWN0KGhhc0xvY2FsRHJhZnQpLnRvQmUodHJ1ZSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCByZXRyaWV2ZSBsb2NhbCBkcmFmdCBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICBjb25zdCBkcmFmdERhdGEgPSB7IGZvcm1EYXRhLCBjdXJyZW50U3RlcDogMiB9XG4gICAgICBsb2NhbFN0b3JhZ2VNb2NrW2BmdW5kaW5nLWRyYWZ0LSR7dXNlcklkfWBdID0gSlNPTi5zdHJpbmdpZnkoZHJhZnREYXRhKVxuXG4gICAgICBjb25zdCBsb2NhbERyYWZ0ID0gY2FtcGFpZ25TZXJ2aWNlLmdldExvY2FsRHJhZnQodXNlcklkKVxuICAgICAgZXhwZWN0KGxvY2FsRHJhZnQpLnRvQmVUcnV0aHkoKVxuICAgICAgZXhwZWN0KGxvY2FsRHJhZnQ/LmZvcm1EYXRhLnRpdGxlKS50b0JlKGZvcm1EYXRhLnRpdGxlKVxuICAgICAgZXhwZWN0KGxvY2FsRHJhZnQ/LmN1cnJlbnRTdGVwKS50b0JlKDIpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2xlYXIgbG9jYWwgZHJhZnQgY29tcGxldGVseScsICgpID0+IHtcbiAgICAgIGxvY2FsU3RvcmFnZU1vY2tbYGZ1bmRpbmctZHJhZnQtJHt1c2VySWR9YF0gPSBKU09OLnN0cmluZ2lmeSh7IGZvcm1EYXRhIH0pXG5cbiAgICAgIGNhbXBhaWduU2VydmljZS5jbGVhckxvY2FsRHJhZnQodXNlcklkKVxuICAgICAgZXhwZWN0KGxvY2FsU3RvcmFnZU1vY2tbYGZ1bmRpbmctZHJhZnQtJHt1c2VySWR9YF0pLnRvQmVVbmRlZmluZWQoKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjb3JydXB0ZWQgbG9jYWxTdG9yYWdlIGdyYWNlZnVsbHknLCAoKSA9PiB7XG4gICAgICBsb2NhbFN0b3JhZ2VNb2NrW2BmdW5kaW5nLWRyYWZ0LSR7dXNlcklkfWBdID0gJ2ludmFsaWQtanNvbi1kYXRhJ1xuXG4gICAgICBjb25zdCBsb2NhbERyYWZ0ID0gY2FtcGFpZ25TZXJ2aWNlLmdldExvY2FsRHJhZnQodXNlcklkKVxuICAgICAgZXhwZWN0KGxvY2FsRHJhZnQpLnRvQmUobnVsbClcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCfimqDvuI8gRXJyb3IgSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZW1wdHkgdXNlciBJRCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGV4cGVjdChjYW1wYWlnblNlcnZpY2UuZ2V0QWxsQ2FtcGFpZ25zKCcnKSkucmVqZWN0cy50b1Rocm93KCdVc2VyIElEIGlzIHJlcXVpcmVkJylcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbnVsbCBmb3JtIGRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBleHBlY3QoY2FtcGFpZ25TZXJ2aWNlLnNhdmVEcmFmdCh1c2VySWQsIG51bGwgYXMgYW55LCAxKSkucmVqZWN0cy50b1Rocm93KCdGb3JtIGRhdGEgaXMgcmVxdWlyZWQnKVxuICAgIH0pXG4gIH0pXG59KSAiXSwidmVyc2lvbiI6M30=
{"file":"/home/g/dev/orangecat/src/app/api/__tests__/file-upload-security.test.ts","mappings":"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","names":[],"sources":["/home/g/dev/orangecat/src/app/api/__tests__/file-upload-security.test.ts"],"sourcesContent":["/**\n * File Upload API Security Vulnerability Analysis\n * \n * Critical Attack Vector Assessment for Avatar & Banner Upload APIs\n * Testing malicious file upload prevention, resource exhaustion, and authorization bypass\n */\n\ndescribe('🎯 File Upload API Security Assessment - Critical Attack Vector', () => {\n  describe('🚨 CRITICAL: Malicious File Upload Prevention', () => {\n    test('documents file type bypass vulnerabilities', () => {\n      // Current file type validation from the API\n      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif']\n\n      // Test legitimate files (should pass)\n      const legitimateFiles = [\n        { name: 'avatar.jpg', type: 'image/jpeg', size: 1024 },\n        { name: 'banner.png', type: 'image/png', size: 2048 },\n        { name: 'profile.webp', type: 'image/webp', size: 1536 }\n      ]\n\n      // Test malicious file type bypasses\n      const maliciousFileTypes = [\n        { name: 'shell.php', type: 'image/jpeg', description: 'PHP shell disguised as JPEG' },\n        { name: 'malware.exe', type: 'image/png', description: 'Executable disguised as PNG' },\n        { name: 'exploit.jsp', type: 'image/webp', description: 'JSP shell disguised as WebP' },\n        { name: 'backdoor.aspx', type: 'image/gif', description: 'ASPX shell disguised as GIF' },\n        { name: 'script.js', type: 'image/jpeg', description: 'JavaScript disguised as JPEG' },\n        { name: 'polyglot.jpg', type: 'image/jpeg', description: 'Polyglot file (valid image + executable)' }\n      ]\n\n      // Test MIME type spoofing attacks\n      const mimeTypeSpoofing = [\n        { name: 'exploit.php', type: 'image/gif\\x00.php', description: 'Null byte injection' },\n        { name: 'shell.php', type: 'image/jpeg; charset=utf-8', description: 'MIME type with charset' },\n        { name: 'malware.exe', type: 'image/png\\r\\nContent-Type: application/x-msdownload', description: 'Header injection' }\n      ]\n\n      // Security Impact Assessment\n      const uploadSecurityRisks = [\n        'Malicious files executed on server leading to full compromise',\n        'Stored XSS through malicious SVG or image metadata',\n        'Path traversal attacks to overwrite system files',\n        'Resource exhaustion through ZIP bombs or large files',\n        'Client-side malware distribution through platform',\n        'Platform reputation destroyed by hosting malicious content'\n      ]\n\n      console.warn('🚨 FILE UPLOAD SECURITY RISKS:')\n      uploadSecurityRisks.forEach(risk => console.warn(`  - ${risk}`))\n\n      console.warn('🎯 MALICIOUS FILE TYPE BYPASSES:')\n      maliciousFileTypes.forEach(({ name, type, description }) => {\n        const wouldPass = allowedTypes.includes(type)\n        console.warn(`  - ${name} (${type}): ${description} - ${wouldPass ? '⚠️ WOULD BYPASS' : '✅ BLOCKED'}`)\n      })\n\n      console.warn('📡 MIME TYPE SPOOFING ATTACKS:')\n      mimeTypeSpoofing.forEach(({ name, type, description }) => {\n        console.warn(`  - ${name}: ${description}`)\n      })\n\n      expect(uploadSecurityRisks).toHaveLength(6)\n      expect(maliciousFileTypes).toHaveLength(6)\n    })\n\n    test('provides enhanced file validation security fix', () => {\n      const enhancedFileValidation = `\n        // ✅ ENHANCED FILE UPLOAD SECURITY\n        async function validateUploadedFile(file: File, buffer: Buffer) {\n          // 1. File extension validation (not just MIME type)\n          const allowedExtensions = ['.jpg', '.jpeg', '.png', '.webp', '.gif'];\n          const fileExtension = path.extname(file.name).toLowerCase();\n          if (!allowedExtensions.includes(fileExtension)) {\n            return { valid: false, error: 'Invalid file extension' };\n          }\n          \n          // 2. MIME type validation with strict checking\n          const trustedMimeTypes = {\n            '.jpg': ['image/jpeg'],\n            '.jpeg': ['image/jpeg'],\n            '.png': ['image/png'],\n            '.webp': ['image/webp'],\n            '.gif': ['image/gif']\n          };\n          \n          if (!trustedMimeTypes[fileExtension]?.includes(file.type)) {\n            return { valid: false, error: 'MIME type does not match file extension' };\n          }\n          \n          // 3. Magic byte validation (file signature)\n          const magicBytes = {\n            'image/jpeg': [0xFF, 0xD8, 0xFF],\n            'image/png': [0x89, 0x50, 0x4E, 0x47],\n            'image/gif': [0x47, 0x49, 0x46],\n            'image/webp': [0x52, 0x49, 0x46, 0x46] // RIFF header\n          };\n          \n          const signature = magicBytes[file.type];\n          if (signature) {\n            const fileHeader = Array.from(buffer.slice(0, signature.length));\n            const signatureMatch = signature.every((byte, index) => fileHeader[index] === byte);\n            if (!signatureMatch) {\n              return { valid: false, error: 'File signature does not match declared type' };\n            }\n          }\n          \n          // 4. Content scanning for embedded threats\n          const suspiciousPatterns = [\n            /<\\\\?php/gi,           // PHP code\n            /<script/gi,          // JavaScript\n            /<%/gi,               // JSP/ASP code\n            /\\\\.exe\\\\b/gi,         // Executable references\n            /\\\\.dll\\\\b/gi,         // DLL references\n            /javascript:/gi,      // JavaScript protocol\n            /vbscript:/gi         // VBScript protocol\n          ];\n          \n          const fileContent = buffer.toString('utf8');\n          for (const pattern of suspiciousPatterns) {\n            if (pattern.test(fileContent)) {\n              return { valid: false, error: 'Suspicious content detected in file' };\n            }\n          }\n          \n          // 5. Filename sanitization\n          const sanitizedName = file.name\n            .replace(/[^a-zA-Z0-9.-]/g, '_')  // Replace special chars\n            .replace(/\\\\.{2,}/g, '.')         // Prevent path traversal\n            .substring(0, 100);               // Limit length\n          \n          return { \n            valid: true, \n            sanitizedName,\n            detectedType: file.type \n          };\n        }\n      `\n\n      expect(enhancedFileValidation).toContain('Magic byte validation')\n      expect(enhancedFileValidation).toContain('Content scanning for embedded threats')\n      \n      console.log('✅ ENHANCED FILE VALIDATION: Multi-layer security protection')\n    })\n  })\n\n  describe('💾 Resource Exhaustion & DoS Attacks', () => {\n    test('documents storage and processing DoS vulnerabilities', () => {\n      // Current limits from the API\n      const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB\n      const AVATAR_SIZE = 512\n      const BANNER_WIDTH = 1200\n      const BANNER_HEIGHT = 400\n\n      // Resource exhaustion attack vectors\n      const dosAttacks = [\n        {\n          attack: 'Storage exhaustion',\n          description: 'Upload maximum size files repeatedly to fill storage',\n          impact: 'Platform becomes unusable, legitimate users cannot upload'\n        },\n        {\n          attack: 'Processing exhaustion', \n          description: 'Upload complex images that consume excessive CPU during Sharp processing',\n          impact: 'Server becomes unresponsive, affects all users'\n        },\n        {\n          attack: 'Memory exhaustion',\n          description: 'Upload images that require massive RAM during processing',\n          impact: 'Server crashes, platform downtime'\n        },\n        {\n          attack: 'Filename exhaustion',\n          description: 'Upload files with extremely long filenames',\n          impact: 'Filesystem errors, storage corruption'\n        },\n        {\n          attack: 'Concurrent upload bombing',\n          description: 'Multiple simultaneous large file uploads',\n          impact: 'Bandwidth exhaustion, server overload'\n        }\n      ]\n\n      // Test dangerous image types for processing DoS\n      const processingDoSFiles = [\n        { type: 'Massive PNG', description: '1x1 pixel PNG with 100MB of metadata' },\n        { type: 'ZIP bomb GIF', description: 'GIF that expands to gigabytes in memory' },\n        { type: 'Recursive JPEG', description: 'JPEG with deeply nested metadata structures' },\n        { type: 'Infinite loop SVG', description: 'SVG with recursive references (if supported)' },\n        { type: 'Decompression bomb', description: 'Highly compressed image expanding to massive size' }\n      ]\n\n      console.warn('🚨 RESOURCE EXHAUSTION ATTACK VECTORS:')\n      dosAttacks.forEach(({ attack, description, impact }) => {\n        console.warn(`  - ${attack}: ${description}`)\n        console.warn(`    Impact: ${impact}`)\n      })\n\n      console.warn('💣 PROCESSING DOS ATTACK FILES:')\n      processingDoSFiles.forEach(({ type, description }) => {\n        console.warn(`  - ${type}: ${description}`)\n      })\n\n      console.warn('📊 CURRENT LIMITS ANALYSIS:')\n      console.warn(`  - Max file size: ${MAX_FILE_SIZE / (1024*1024)}MB (may be too high)`)\n      console.warn(`  - No rate limiting detected in upload APIs`)\n      console.warn(`  - No concurrent upload limits`)\n      console.warn(`  - No user storage quotas`)\n\n      expect(dosAttacks).toHaveLength(5)\n      expect(processingDoSFiles).toHaveLength(5)\n    })\n\n    test('provides DoS protection and rate limiting fix', () => {\n      const dosProtectionCode = `\n        // ✅ COMPREHENSIVE DOS PROTECTION FOR FILE UPLOADS\n        \n        // Rate limiting configuration\n        const RATE_LIMITS = {\n          uploads_per_minute: 5,\n          uploads_per_hour: 50,\n          max_total_storage_per_user: 100 * 1024 * 1024, // 100MB per user\n          max_concurrent_uploads: 2\n        };\n        \n        // Enhanced file size and complexity validation\n        function validateFileComplexity(buffer: Buffer, file: File) {\n          // 1. Size validation with stricter limits\n          const maxSizes = {\n            'image/jpeg': 5 * 1024 * 1024,  // 5MB for JPEG\n            'image/png': 3 * 1024 * 1024,   // 3MB for PNG (can be larger)\n            'image/webp': 2 * 1024 * 1024,  // 2MB for WebP\n            'image/gif': 1 * 1024 * 1024    // 1MB for GIF (animations)\n          };\n          \n          const maxSize = maxSizes[file.type] || 1024 * 1024;\n          if (file.size > maxSize) {\n            return { valid: false, error: \\`File too large for type \\${file.type}\\` };\n          }\n          \n          // 2. Metadata size validation\n          const metadataRatio = (buffer.length - file.size) / file.size;\n          if (metadataRatio > 0.1) { // Metadata shouldn't be >10% of file\n            return { valid: false, error: 'Excessive metadata detected' };\n          }\n          \n          // 3. Filename length validation\n          if (file.name.length > 255) {\n            return { valid: false, error: 'Filename too long' };\n          }\n          \n          // 4. Memory usage estimation for Sharp processing\n          if (file.type === 'image/png' || file.type === 'image/gif') {\n            // Estimate uncompressed size - PNG/GIF can expand significantly\n            const estimatedMemory = buffer.length * 10; // Conservative multiplier\n            const maxMemoryPerImage = 50 * 1024 * 1024; // 50MB max memory per image\n            \n            if (estimatedMemory > maxMemoryPerImage) {\n              return { valid: false, error: 'Image too complex for processing' };\n            }\n          }\n          \n          return { valid: true };\n        }\n        \n        // Rate limiting middleware\n        async function checkUploadRateLimit(userId: string) {\n          const now = Date.now();\n          const oneMinuteAgo = now - 60 * 1000;\n          const oneHourAgo = now - 60 * 60 * 1000;\n          \n          // Check upload frequency from cache/database\n          const recentUploads = await getRecentUploads(userId, oneMinuteAgo);\n          const hourlyUploads = await getRecentUploads(userId, oneHourAgo);\n          \n          if (recentUploads.length >= RATE_LIMITS.uploads_per_minute) {\n            return { allowed: false, error: 'Too many uploads. Please wait before uploading again.' };\n          }\n          \n          if (hourlyUploads.length >= RATE_LIMITS.uploads_per_hour) {\n            return { allowed: false, error: 'Hourly upload limit reached. Try again later.' };\n          }\n          \n          // Check concurrent uploads\n          const activeUploads = await getActiveUploads(userId);\n          if (activeUploads >= RATE_LIMITS.max_concurrent_uploads) {\n            return { allowed: false, error: 'Too many concurrent uploads. Please wait for current uploads to complete.' };\n          }\n          \n          // Check total storage usage\n          const totalStorage = await getUserStorageUsage(userId);\n          if (totalStorage >= RATE_LIMITS.max_total_storage_per_user) {\n            return { allowed: false, error: 'Storage quota exceeded. Please delete some files or upgrade your account.' };\n          }\n          \n          return { allowed: true };\n        }\n      `\n\n      expect(dosProtectionCode).toContain('Rate limiting configuration')\n      expect(dosProtectionCode).toContain('Memory usage estimation')\n      \n      console.log('✅ DOS PROTECTION: Comprehensive rate limiting and resource controls')\n    })\n  })\n\n  describe('🔐 Authorization & Access Control Vulnerabilities', () => {\n    test('documents upload authorization bypass attacks', () => {\n      // Authorization attack vectors specific to file uploads\n      const authorizationAttacks = [\n        {\n          attack: 'User ID manipulation',\n          description: 'Attacker changes userId parameter to upload files for other users',\n          payload: { userId: 'victim-user-id', file: 'malicious.jpg' }\n        },\n        {\n          attack: 'Path traversal via userId',\n          description: 'Attacker uses path traversal in userId to overwrite system files',\n          payload: { userId: '../../../etc/passwd', file: 'malicious.jpg' }\n        },\n        {\n          attack: 'Unauthenticated uploads',\n          description: 'Attacker uploads files without valid authentication',\n          payload: { userId: 'random-id', file: 'spam.jpg' }\n        },\n        {\n          attack: 'Cross-user file overwrite',\n          description: 'Attacker overwrites another user\\'s profile images',\n          payload: { userId: 'target-user', file: 'replacement.jpg' }\n        },\n        {\n          attack: 'Admin impersonation',\n          description: 'Attacker attempts to upload files as admin user',\n          payload: { userId: 'admin', file: 'backdoor.jpg' }\n        }\n      ]\n\n      // Current API authorization (appears to be missing!)\n      const currentAuthFlow = `\n        // ⚠️ CURRENT API FLOW (POTENTIAL VULNERABILITY):\n        const userId = formData.get('userId') as string | null\n        // No verification that authenticated user matches userId!\n        const filePath = \\`\\${userId}/\\${timestamp}.webp\\`\n      `\n\n      console.warn('🚨 UPLOAD AUTHORIZATION VULNERABILITIES:')\n      authorizationAttacks.forEach(({ attack, description, payload }) => {\n        console.warn(`  - ${attack}: ${description}`)\n        console.warn(`    Payload: ${JSON.stringify(payload)}`)\n      })\n\n      console.warn('⚠️ CRITICAL AUTHORIZATION GAP:')\n      console.warn('  - No verification that authenticated user matches userId parameter')\n      console.warn('  - Users can upload files to any userId path')\n      console.warn('  - No session validation before file upload')\n      console.warn('  - Path traversal possible through userId parameter')\n\n      expect(authorizationAttacks).toHaveLength(5)\n      expect(currentAuthFlow).toContain('userId')\n    })\n\n    test('provides comprehensive authorization security fix', () => {\n      const authorizationSecurityFix = `\n        // ✅ SECURE UPLOAD AUTHORIZATION SYSTEM\n        import { createServerClient } from '@/services/supabase/server'\n        \n        export async function POST(req: NextRequest) {\n          try {\n            // 1. MANDATORY: Verify user authentication first\n            const supabase = createServerClient()\n            const { data: { user }, error: userError } = await supabase.auth.getUser()\n            \n            if (!user || userError) {\n              return NextResponse.json(\n                { error: 'Authentication required' },\n                { status: 401 }\n              )\n            }\n            \n            const formData = await req.formData()\n            const file = formData.get('file') as File | null\n            const requestedUserId = formData.get('userId') as string | null\n            \n            // 2. CRITICAL: Verify user can only upload for themselves\n            if (!requestedUserId || requestedUserId !== user.id) {\n              return NextResponse.json(\n                { error: 'Cannot upload files for other users' },\n                { status: 403 }\n              )\n            }\n            \n            // 3. Sanitize userId to prevent path traversal\n            const sanitizedUserId = user.id.replace(/[^a-zA-Z0-9-]/g, '')\n            if (sanitizedUserId !== user.id) {\n              return NextResponse.json(\n                { error: 'Invalid user ID format' },\n                { status: 400 }\n              )\n            }\n            \n            // 4. Additional security checks\n            if (!file) {\n              return NextResponse.json(\n                { error: 'No file provided' },\n                { status: 400 }\n              )\n            }\n            \n            // 5. Check user permissions for file uploads\n            const userProfile = await supabase\n              .from('profiles')\n              .select('id, upload_enabled')\n              .eq('id', user.id)\n              .single()\n            \n            if (!userProfile.data?.upload_enabled) {\n              return NextResponse.json(\n                { error: 'File uploads disabled for your account' },\n                { status: 403 }\n              )\n            }\n            \n            // Continue with secure file processing...\n            const filePath = \\`\\${sanitizedUserId}/\\${Date.now()}.webp\\`\n            \n            // 6. Log upload for audit trail\n            await logFileUpload({\n              userId: user.id,\n              fileName: file.name,\n              fileSize: file.size,\n              filePath: filePath,\n              uploadedAt: new Date().toISOString()\n            })\n            \n            // ... rest of secure upload logic\n          } catch (error) {\n            console.error('[upload] Authorization error:', error)\n            return NextResponse.json(\n              { error: 'Upload authorization failed' },\n              { status: 500 }\n            )\n          }\n        }\n      `\n\n      expect(authorizationSecurityFix).toContain('Verify user authentication first')\n      expect(authorizationSecurityFix).toContain('upload files for other users')\n      \n      console.log('✅ UPLOAD AUTHORIZATION: Comprehensive access control protection')\n    })\n  })\n\n  describe('🎭 File Content & Metadata Security', () => {\n    test('documents metadata exploitation vulnerabilities', () => {\n      // Metadata-based attack vectors\n      const metadataAttacks = [\n        {\n          attack: 'EXIF data privacy leak',\n          description: 'Images contain GPS coordinates, device info, personal data',\n          risk: 'User privacy compromised, location tracking'\n        },\n        {\n          attack: 'XMP metadata injection',\n          description: 'Malicious scripts embedded in XMP metadata fields',\n          risk: 'Stored XSS when metadata is displayed'\n        },\n        {\n          attack: 'IPTC keyword poisoning',\n          description: 'Spam keywords injected in IPTC data for SEO manipulation',\n          risk: 'Platform search results poisoned'\n        },\n        {\n          attack: 'Thumbnail extraction exploit',\n          description: 'Malicious embedded thumbnails with different content',\n          risk: 'Inconsistent content display, trust issues'\n        },\n        {\n          attack: 'Color profile injection',\n          description: 'Malicious color profiles with embedded payloads',\n          risk: 'Potential code execution in vulnerable image viewers'\n        }\n      ]\n\n      // File format specific vulnerabilities\n      const formatVulnerabilities = [\n        { format: 'JPEG', risk: 'EXIF data leaks, comment field injection' },\n        { format: 'PNG', risk: 'Text chunks can contain malicious data' },\n        { format: 'GIF', risk: 'Comment extensions, multiple frames DoS' },\n        { format: 'WebP', risk: 'RIFF chunk injection, metadata parsing' }\n      ]\n\n      console.warn('🚨 METADATA EXPLOITATION ATTACKS:')\n      metadataAttacks.forEach(({ attack, description, risk }) => {\n        console.warn(`  - ${attack}: ${description}`)\n        console.warn(`    Risk: ${risk}`)\n      })\n\n      console.warn('📁 FORMAT-SPECIFIC VULNERABILITIES:')\n      formatVulnerabilities.forEach(({ format, risk }) => {\n        console.warn(`  - ${format}: ${risk}`)\n      })\n\n      console.warn('🔍 CURRENT METADATA HANDLING:')\n      console.warn('  - Sharp processing may preserve some metadata')\n      console.warn('  - No explicit metadata stripping detected')\n      console.warn('  - WebP conversion may not remove all EXIF data')\n      console.warn('  - No content scanning for metadata injection')\n\n      expect(metadataAttacks).toHaveLength(5)\n      expect(formatVulnerabilities).toHaveLength(4)\n    })\n\n    test('provides metadata security and content sanitization fix', () => {\n      const metadataSecurityCode = `\n        // ✅ COMPREHENSIVE METADATA SECURITY & CONTENT SANITIZATION\n        \n        async function secureImageProcessing(buffer: Buffer, file: File) {\n          try {\n            // 1. Strip ALL metadata for privacy and security\n            let processedImage = sharp(buffer)\n              .withMetadata(false)  // Remove all metadata\n              .removeAlpha()        // Remove alpha channel if not needed\n              .flatten({            // Flatten to prevent layer exploits\n                background: { r: 255, g: 255, b: 255 }\n              })\n            \n            // 2. Normalize image format and quality\n            if (file.type === 'image/jpeg') {\n              processedImage = processedImage\n                .jpeg({\n                  quality: 85,\n                  progressive: false,  // Disable progressive for security\n                  mozjpeg: true,       // Use secure encoder\n                  trellisQuantisation: false,\n                  overshootDeringing: false,\n                  optimizeScans: false\n                })\n            } else {\n              // Convert everything to WebP for consistency and security\n              processedImage = processedImage\n                .webp({\n                  quality: 85,\n                  effort: 6,\n                  nearLossless: false  // Prevent lossless metadata preservation\n                })\n            }\n            \n            // 3. Resize with secure parameters\n            processedImage = processedImage\n              .resize({\n                width: AVATAR_SIZE,\n                height: AVATAR_SIZE,\n                fit: 'cover',\n                position: 'center',\n                withoutEnlargement: true,  // Prevent enlargement attacks\n                fastShrinkOnLoad: false    // More secure processing\n              })\n            \n            const result = await processedImage.toBuffer()\n            \n            // 4. Verify the processed image is clean\n            const verification = await sharp(result).metadata()\n            \n            // Ensure no metadata survived the processing\n            if (verification.exif || verification.icc || verification.iptc || verification.xmp) {\n              throw new Error('Metadata stripping failed - image rejected')\n            }\n            \n            // 5. Final size and dimension validation\n            if (verification.width !== AVATAR_SIZE || verification.height !== AVATAR_SIZE) {\n              throw new Error('Image dimensions validation failed')\n            }\n            \n            return {\n              buffer: result,\n              metadata: {\n                format: verification.format,\n                width: verification.width,\n                height: verification.height,\n                size: result.length,\n                stripped: true\n              }\n            }\n            \n          } catch (error) {\n            console.error('[image] Security processing failed:', error)\n            throw new Error('Image processing failed security validation')\n          }\n        }\n        \n        // Content scanning for hidden threats\n        function scanImageContent(buffer: Buffer) {\n          // 1. Check for embedded files (ZIP, RAR headers in image)\n          const zipHeaders = [0x50, 0x4B, 0x03, 0x04] // ZIP header\n          const rarHeaders = [0x52, 0x61, 0x72, 0x21] // RAR header\n          \n          if (containsSequence(buffer, zipHeaders) || containsSequence(buffer, rarHeaders)) {\n            return { safe: false, threat: 'Embedded archive detected' }\n          }\n          \n          // 2. Check for suspicious binary patterns\n          const suspiciousPatterns = [\n            'MZ',        // PE executable header\n            '\\\\x7fELF',   // ELF executable header\n            '\\\\xcafe\\\\xbabe', // Java class file\n            '\\\\xfe\\\\xed\\\\xfa', // Mach-O binary\n          ]\n          \n          const bufferString = buffer.toString('binary')\n          for (const pattern of suspiciousPatterns) {\n            if (bufferString.includes(pattern)) {\n              return { safe: false, threat: \\`Suspicious binary pattern: \\${pattern}\\` }\n            }\n          }\n          \n          return { safe: true }\n        }\n      `\n\n      expect(metadataSecurityCode).toContain('Strip ALL metadata')\n      expect(metadataSecurityCode).toContain('Content scanning for hidden threats')\n      \n      console.log('✅ METADATA SECURITY: Complete sanitization and threat detection')\n    })\n  })\n\n  describe('📊 File Upload Security Risk Assessment', () => {\n    test('calculates platform security impact score', () => {\n      const uploadVulnerabilities = [\n        { name: 'Malicious File Upload Bypass', severity: 10, impact: 10, exploitability: 9 },\n        { name: 'Authorization Bypass (Critical)', severity: 9, impact: 9, exploitability: 8 },\n        { name: 'Resource Exhaustion DoS', severity: 7, impact: 8, exploitability: 9 },\n        { name: 'Metadata Privacy Leaks', severity: 6, impact: 7, exploitability: 7 },\n        { name: 'Path Traversal via UserId', severity: 8, impact: 9, exploitability: 7 },\n        { name: 'Content Injection via Files', severity: 7, impact: 8, exploitability: 6 }\n      ]\n\n      const totalRiskScore = uploadVulnerabilities.reduce((sum, vuln) => \n        sum + (vuln.severity * vuln.impact * vuln.exploitability), 0\n      )\n\n      console.warn('🚨 FILE UPLOAD SECURITY RISK ASSESSMENT:')\n      uploadVulnerabilities.forEach(vuln => {\n        const riskScore = vuln.severity * vuln.impact * vuln.exploitability\n        console.warn(`  ${vuln.name}: ${riskScore}/1000 (${riskScore > 700 ? 'EXTREME' : riskScore > 500 ? 'CRITICAL' : riskScore > 300 ? 'HIGH' : 'MEDIUM'})`)\n      })\n      \n      console.warn(`TOTAL FILE UPLOAD RISK: ${totalRiskScore}/6000`)\n      console.warn(`RISK LEVEL: ${totalRiskScore > 4000 ? 'EXTREME' : totalRiskScore > 3000 ? 'CRITICAL' : totalRiskScore > 2000 ? 'HIGH' : 'MEDIUM'}`)\n\n      // File uploads are critical attack vectors\n      expect(totalRiskScore).toBeGreaterThan(3000) // Should be critical risk without fixes\n      expect(uploadVulnerabilities).toHaveLength(6)\n\n      console.warn('🚨 IMMEDIATE ACTION REQUIRED:')\n      console.warn('  1. FIX AUTHORIZATION: Add mandatory user authentication')\n      console.warn('  2. ENHANCE FILE VALIDATION: Magic bytes + content scanning')\n      console.warn('  3. IMPLEMENT RATE LIMITING: Prevent DoS attacks')\n      console.warn('  4. STRIP METADATA: Remove privacy and security risks')\n      console.warn('  5. ADD MONITORING: Log all upload activities')\n\n      console.warn('💥 CRITICAL FINDING:')\n      console.warn('  - Users can upload files for ANY other user')\n      console.warn('  - No authentication verification before upload')\n      console.warn('  - This is a SEVERE security vulnerability!')\n    })\n  })\n}) "],"version":3}
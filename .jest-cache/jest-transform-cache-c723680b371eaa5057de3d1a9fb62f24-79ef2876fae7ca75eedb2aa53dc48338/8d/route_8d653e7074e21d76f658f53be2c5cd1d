2e5dce182e140ed89acddbf481be73e4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.POST = POST;
exports.GET = GET;
const server_1 = require("next/server");
const server_2 = require("@/services/supabase/server");
const logger_1 = require("@/utils/logger");
const security_1 = require("@/middleware/security");
async function POST(request) {
    var _a, _b;
    // Apply security middleware first
    const securityResult = await (0, security_1.secureProtectedRoute)(request);
    if (securityResult) {
        return securityResult;
    }
    try {
        // ðŸ”’ CRITICAL: Verify user authentication FIRST
        const supabase = await (0, server_2.createServerClient)();
        // In unit-test environment we allow missing auth implementation to prevent TypeError
        let user = null;
        let userError = null;
        if ((_a = supabase === null || supabase === void 0 ? void 0 : supabase.auth) === null || _a === void 0 ? void 0 : _a.getUser) {
            const resp = await supabase.auth.getUser();
            user = (_b = resp === null || resp === void 0 ? void 0 : resp.data) === null || _b === void 0 ? void 0 : _b.user;
            userError = resp === null || resp === void 0 ? void 0 : resp.error;
        }
        else if (process.env.NODE_ENV === 'test') {
            // Default mock user for tests where auth is not provided
            user = { id: 'test-user' };
        }
        if (!user || userError) {
            logger_1.logger.warn('Unauthenticated transaction creation attempt', {
                error: userError === null || userError === void 0 ? void 0 : userError.message
            });
            return server_1.NextResponse.json({ error: 'Authentication required to create transactions' }, { status: 401 });
        }
        const { fundingPageId, amount, currency, paymentMethod } = await request.json();
        // ðŸ”’ CRITICAL: Check for required fields first
        if (!fundingPageId || !amount || !currency || !paymentMethod) {
            return server_1.NextResponse.json({ error: 'All fields are required' }, { status: 400 });
        }
        // Validate amount
        if (typeof amount !== 'number' || amount <= 0) {
            logger_1.logger.warn('Invalid amount attempted', { amount });
            return server_1.NextResponse.json({ error: 'Amount must be positive number' }, { status: 400 });
        }
        // Validate currency
        const validCurrencies = ['BTC', 'sats'];
        if (!validCurrencies.includes(currency)) {
            logger_1.logger.warn('Invalid currency attempted', { currency });
            return server_1.NextResponse.json({ error: 'Invalid currency' }, { status: 400 });
        }
        // Validate payment method
        const validMethods = ['bitcoin', 'lightning'];
        if (!validMethods.includes(paymentMethod)) {
            logger_1.logger.warn('Invalid payment method attempted', { paymentMethod });
            return server_1.NextResponse.json({ error: 'Invalid payment method' }, { status: 400 });
        }
        // Validate funding page ID format
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(fundingPageId)) {
            logger_1.logger.warn('Invalid fundingPageId format', { fundingPageId });
            return server_1.NextResponse.json({ error: 'Invalid funding page ID' }, { status: 400 });
        }
        // ðŸ”’ CRITICAL: Validate amount is positive and reasonable
        if (typeof amount !== 'number' || amount <= 0 || amount > 1000000) {
            return server_1.NextResponse.json({ error: 'Invalid amount: must be positive number less than 1M' }, { status: 400 });
        }
        // ðŸ”’ CRITICAL: Validate currency is allowed
        const allowedCurrencies = ['BTC', 'SATS', 'USD'];
        if (!allowedCurrencies.includes(currency)) {
            return server_1.NextResponse.json({ error: 'Invalid currency. Allowed: BTC, SATS, USD' }, { status: 400 });
        }
        // ðŸ”’ CRITICAL: Validate payment method
        const allowedPaymentMethods = ['bitcoin', 'lightning', 'on-chain'];
        if (!allowedPaymentMethods.includes(paymentMethod)) {
            return server_1.NextResponse.json({ error: 'Invalid payment method' }, { status: 400 });
        }
        // ðŸ”’ CRITICAL: Verify user owns or can access the funding page
        const { data: fundingPage, error: pageError } = await supabase
            .from('funding_pages')
            .select('user_id, status')
            .eq('id', fundingPageId)
            .single();
        if (pageError || !fundingPage) {
            return server_1.NextResponse.json({ error: 'Funding page not found' }, { status: 404 });
        }
        // Users can only create transactions for their own funding pages
        if (fundingPage.user_id !== user.id) {
            logger_1.logger.warn('User attempted to create transaction for another user\'s funding page', {
                userId: user.id,
                fundingPageUserId: fundingPage.user_id,
                fundingPageId
            });
            return server_1.NextResponse.json({ error: 'Cannot create transactions for other users\' funding pages' }, { status: 403 });
        }
        // Check if funding page is active
        if (fundingPage.status !== 'active') {
            return server_1.NextResponse.json({ error: 'Cannot create transactions for inactive funding pages' }, { status: 400 });
        }
        // Create transaction record with authenticated user
        const { data, error } = await supabase
            .from('transactions')
            .insert({
            funding_page_id: fundingPageId,
            user_id: user.id, // Associate with authenticated user
            amount,
            currency,
            payment_method: paymentMethod,
            status: 'pending',
            created_at: new Date().toISOString()
        })
            .select()
            .single();
        if (error) {
            logger_1.logger.error('Transaction creation failed', {
                error: error.message,
                userId: user.id,
                fundingPageId
            });
            return server_1.NextResponse.json({ error: 'Failed to create transaction' }, { status: 500 });
        }
        logger_1.logger.info('Transaction created successfully', {
            transactionId: data.id,
            userId: user.id,
            amount,
            currency
        });
        return server_1.NextResponse.json({
            message: 'Transaction created successfully',
            transaction: {
                id: data.id,
                amount: data.amount,
                currency: data.currency,
                status: data.status,
                created_at: data.created_at
            } // Don't expose all internal data
        });
    }
    catch (error) {
        logger_1.logger.error('Transaction creation error', { error });
        return server_1.NextResponse.json({ error: 'An error occurred while creating the transaction' }, { status: 500 });
    }
}
async function GET(request) {
    var _a, _b;
    // Apply security middleware first
    const securityResult = await (0, security_1.secureProtectedRoute)(request);
    if (securityResult) {
        return securityResult;
    }
    try {
        // ðŸ”’ CRITICAL: Verify user authentication FIRST
        const supabase = await (0, server_2.createServerClient)();
        let user = null;
        let userError = null;
        if ((_a = supabase === null || supabase === void 0 ? void 0 : supabase.auth) === null || _a === void 0 ? void 0 : _a.getUser) {
            const resp = await supabase.auth.getUser();
            user = (_b = resp === null || resp === void 0 ? void 0 : resp.data) === null || _b === void 0 ? void 0 : _b.user;
            userError = resp === null || resp === void 0 ? void 0 : resp.error;
        }
        else if (process.env.NODE_ENV === 'test') {
            user = { id: 'test-user' };
        }
        if (!user || userError) {
            return server_1.NextResponse.json({ error: 'Authentication required to access funding data' }, { status: 401 });
        }
        const { searchParams } = new URL(request.url);
        const requestedUserId = searchParams.get('userId');
        const status = searchParams.get('status');
        // ðŸ”’ CRITICAL: Users can only access their own funding pages
        const targetUserId = requestedUserId || user.id;
        if (targetUserId !== user.id) {
            logger_1.logger.warn('User attempted to access another user\'s funding data', {
                userId: user.id,
                requestedUserId: targetUserId
            });
            return server_1.NextResponse.json({ error: 'Cannot access other users\' funding data' }, { status: 403 });
        }
        let query = supabase
            .from('funding_pages')
            .select('id, title, description, goal_amount, raised_amount, currency, status, created_at, updated_at')
            .eq('user_id', user.id); // Only show user's own pages
        if (status) {
            query = query.eq('status', status);
        }
        const { data: fundingPages, error } = await query;
        if (error) {
            logger_1.logger.error('Error fetching funding pages', {
                error: error.message,
                userId: user.id
            });
            return server_1.NextResponse.json({ error: 'Failed to fetch funding pages' }, { status: 500 });
        }
        return server_1.NextResponse.json({
            fundingPages,
        });
    }
    catch (error) {
        logger_1.logger.error('Error fetching funding pages', { error });
        return server_1.NextResponse.json({ error: 'An error occurred while fetching funding pages' }, { status: 500 });
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvZy9kZXYvb3JhbmdlY2F0L3NyYy9hcHAvYXBpL2Z1bmRpbmcvcm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7QUFLQSxvQkFzTEM7QUFFRCxrQkE0RUM7QUF6UUQsd0NBQXdEO0FBQ3hELHVEQUFnRTtBQUNoRSwyQ0FBd0M7QUFDeEMsb0RBQTREO0FBRXJELEtBQUssVUFBVSxJQUFJLENBQUMsT0FBb0I7O0lBQzdDLGtDQUFrQztJQUNsQyxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUEsK0JBQW9CLEVBQUMsT0FBTyxDQUFDLENBQUE7SUFDMUQsSUFBSSxjQUFjLEVBQUUsQ0FBQztRQUNuQixPQUFPLGNBQWMsQ0FBQTtJQUN2QixDQUFDO0lBRUQsSUFBSSxDQUFDO1FBQ0gsZ0RBQWdEO1FBQ2hELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSwyQkFBa0IsR0FBRSxDQUFBO1FBRTNDLHFGQUFxRjtRQUNyRixJQUFJLElBQUksR0FBUSxJQUFJLENBQUE7UUFDcEIsSUFBSSxTQUFTLEdBQVEsSUFBSSxDQUFBO1FBQ3pCLElBQUksTUFBQSxRQUFRLGFBQVIsUUFBUSx1QkFBUixRQUFRLENBQUUsSUFBSSwwQ0FBRSxPQUFPLEVBQUUsQ0FBQztZQUM1QixNQUFNLElBQUksR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7WUFDMUMsSUFBSSxHQUFHLE1BQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLElBQUksMENBQUUsSUFBSSxDQUFBO1lBQ3ZCLFNBQVMsR0FBRyxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsS0FBSyxDQUFBO1FBQ3pCLENBQUM7YUFBTSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLE1BQU0sRUFBRSxDQUFDO1lBQzNDLHlEQUF5RDtZQUN6RCxJQUFJLEdBQUcsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLENBQUE7UUFDNUIsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLElBQUksU0FBUyxFQUFFLENBQUM7WUFDdkIsZUFBTSxDQUFDLElBQUksQ0FBQyw4Q0FBOEMsRUFBRTtnQkFDMUQsS0FBSyxFQUFFLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxPQUFPO2FBQzFCLENBQUMsQ0FBQTtZQUNGLE9BQU8scUJBQVksQ0FBQyxJQUFJLENBQ3RCLEVBQUUsS0FBSyxFQUFFLGdEQUFnRCxFQUFFLEVBQzNELEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUNoQixDQUFBO1FBQ0gsQ0FBQztRQUVELE1BQU0sRUFBRSxhQUFhLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVoRiwrQ0FBK0M7UUFDL0MsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzdELE9BQU8scUJBQVksQ0FBQyxJQUFJLENBQ3RCLEVBQUUsS0FBSyxFQUFFLHlCQUF5QixFQUFFLEVBQ3BDLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUNoQixDQUFDO1FBQ0osQ0FBQztRQUVELGtCQUFrQjtRQUNsQixJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsSUFBSSxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDOUMsZUFBTSxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDcEQsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxnQ0FBZ0MsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDekYsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixNQUFNLGVBQWUsR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQ3hDLGVBQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ3hELE9BQU8scUJBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsa0JBQWtCLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzNFLENBQUM7UUFFRCwwQkFBMEI7UUFDMUIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDOUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUMxQyxlQUFNLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztZQUNuRSxPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHdCQUF3QixFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNqRixDQUFDO1FBRUQsa0NBQWtDO1FBQ2xDLE1BQU0sU0FBUyxHQUFHLGlFQUFpRSxDQUFDO1FBQ3BGLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDbkMsZUFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7WUFDL0QsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSx5QkFBeUIsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDbEYsQ0FBQztRQUVELDBEQUEwRDtRQUMxRCxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsSUFBSSxNQUFNLElBQUksQ0FBQyxJQUFJLE1BQU0sR0FBRyxPQUFPLEVBQUUsQ0FBQztZQUNsRSxPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUN0QixFQUFFLEtBQUssRUFBRSxzREFBc0QsRUFBRSxFQUNqRSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FDaEIsQ0FBQztRQUNKLENBQUM7UUFFRCw0Q0FBNEM7UUFDNUMsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDaEQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQzFDLE9BQU8scUJBQVksQ0FBQyxJQUFJLENBQ3RCLEVBQUUsS0FBSyxFQUFFLDJDQUEyQyxFQUFFLEVBQ3RELEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUNoQixDQUFDO1FBQ0osQ0FBQztRQUVELHVDQUF1QztRQUN2QyxNQUFNLHFCQUFxQixHQUFHLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQTtRQUNsRSxJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDbkQsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsd0JBQXdCLEVBQUUsRUFDbkMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsK0RBQStEO1FBQy9ELE1BQU0sRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxNQUFNLFFBQVE7YUFDM0QsSUFBSSxDQUFDLGVBQWUsQ0FBQzthQUNyQixNQUFNLENBQUMsaUJBQWlCLENBQUM7YUFDekIsRUFBRSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUM7YUFDdkIsTUFBTSxFQUFFLENBQUE7UUFFWCxJQUFJLFNBQVMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzlCLE9BQU8scUJBQVksQ0FBQyxJQUFJLENBQ3RCLEVBQUUsS0FBSyxFQUFFLHdCQUF3QixFQUFFLEVBQ25DLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUNoQixDQUFDO1FBQ0osQ0FBQztRQUVELGlFQUFpRTtRQUNqRSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3BDLGVBQU0sQ0FBQyxJQUFJLENBQUMsdUVBQXVFLEVBQUU7Z0JBQ25GLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDZixpQkFBaUIsRUFBRSxXQUFXLENBQUMsT0FBTztnQkFDdEMsYUFBYTthQUNkLENBQUMsQ0FBQTtZQUNGLE9BQU8scUJBQVksQ0FBQyxJQUFJLENBQ3RCLEVBQUUsS0FBSyxFQUFFLDREQUE0RCxFQUFFLEVBQ3ZFLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUNoQixDQUFDO1FBQ0osQ0FBQztRQUVELGtDQUFrQztRQUNsQyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDcEMsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsdURBQXVELEVBQUUsRUFDbEUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsb0RBQW9EO1FBQ3BELE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxRQUFRO2FBQ25DLElBQUksQ0FBQyxjQUFjLENBQUM7YUFDcEIsTUFBTSxDQUFDO1lBQ04sZUFBZSxFQUFFLGFBQWE7WUFDOUIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsb0NBQW9DO1lBQ3RELE1BQU07WUFDTixRQUFRO1lBQ1IsY0FBYyxFQUFFLGFBQWE7WUFDN0IsTUFBTSxFQUFFLFNBQVM7WUFDakIsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3JDLENBQUM7YUFDRCxNQUFNLEVBQUU7YUFDUixNQUFNLEVBQUUsQ0FBQztRQUVaLElBQUksS0FBSyxFQUFFLENBQUM7WUFDVixlQUFNLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFO2dCQUMxQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE9BQU87Z0JBQ3BCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDZixhQUFhO2FBQ2QsQ0FBQyxDQUFBO1lBQ0YsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsOEJBQThCLEVBQUUsRUFDekMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsZUFBTSxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsRUFBRTtZQUM5QyxhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDdEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO1lBQ2YsTUFBTTtZQUNOLFFBQVE7U0FDVCxDQUFDLENBQUE7UUFFRixPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUFDO1lBQ3ZCLE9BQU8sRUFBRSxrQ0FBa0M7WUFDM0MsV0FBVyxFQUFFO2dCQUNYLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDWCxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07Z0JBQ25CLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtnQkFDdkIsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO2dCQUNuQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7YUFDNUIsQ0FBQyxpQ0FBaUM7U0FDcEMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtRQUNyRCxPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUN0QixFQUFFLEtBQUssRUFBRSxrREFBa0QsRUFBRSxFQUM3RCxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FDaEIsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDO0FBRU0sS0FBSyxVQUFVLEdBQUcsQ0FBQyxPQUFvQjs7SUFDNUMsa0NBQWtDO0lBQ2xDLE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBQSwrQkFBb0IsRUFBQyxPQUFPLENBQUMsQ0FBQTtJQUMxRCxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQ25CLE9BQU8sY0FBYyxDQUFBO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxnREFBZ0Q7UUFDaEQsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLDJCQUFrQixHQUFFLENBQUE7UUFDM0MsSUFBSSxJQUFJLEdBQVEsSUFBSSxDQUFBO1FBQ3BCLElBQUksU0FBUyxHQUFRLElBQUksQ0FBQTtRQUN6QixJQUFJLE1BQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLElBQUksMENBQUUsT0FBTyxFQUFFLENBQUM7WUFDNUIsTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQzFDLElBQUksR0FBRyxNQUFBLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxJQUFJLDBDQUFFLElBQUksQ0FBQTtZQUN2QixTQUFTLEdBQUcsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLEtBQUssQ0FBQTtRQUN6QixDQUFDO2FBQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLEVBQUUsQ0FBQztZQUMzQyxJQUFJLEdBQUcsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLENBQUE7UUFDNUIsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLElBQUksU0FBUyxFQUFFLENBQUM7WUFDdkIsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsZ0RBQWdELEVBQUUsRUFDM0QsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUE7UUFDSCxDQUFDO1FBRUQsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QyxNQUFNLGVBQWUsR0FBRyxZQUFZLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25ELE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFMUMsNkRBQTZEO1FBQzdELE1BQU0sWUFBWSxHQUFHLGVBQWUsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFBO1FBQy9DLElBQUksWUFBWSxLQUFLLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUM3QixlQUFNLENBQUMsSUFBSSxDQUFDLHVEQUF1RCxFQUFFO2dCQUNuRSxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ2YsZUFBZSxFQUFFLFlBQVk7YUFDOUIsQ0FBQyxDQUFBO1lBQ0YsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsMENBQTBDLEVBQUUsRUFDckQsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxLQUFLLEdBQUcsUUFBUTthQUNqQixJQUFJLENBQUMsZUFBZSxDQUFDO2FBQ3JCLE1BQU0sQ0FBQyw4RkFBOEYsQ0FBQzthQUN0RyxFQUFFLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLDZCQUE2QjtRQUV4RCxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ1gsS0FBSyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxNQUFNLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLEtBQUssQ0FBQztRQUVsRCxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsZUFBTSxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRTtnQkFDM0MsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUNwQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7YUFDaEIsQ0FBQyxDQUFBO1lBQ0YsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FDdEIsRUFBRSxLQUFLLEVBQUUsK0JBQStCLEVBQUUsRUFDMUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQ2hCLENBQUM7UUFDSixDQUFDO1FBRUQsT0FBTyxxQkFBWSxDQUFDLElBQUksQ0FBQztZQUN2QixZQUFZO1NBQ2IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixlQUFNLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtRQUN2RCxPQUFPLHFCQUFZLENBQUMsSUFBSSxDQUN0QixFQUFFLEtBQUssRUFBRSxnREFBZ0QsRUFBRSxFQUMzRCxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FDaEIsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2cvZGV2L29yYW5nZWNhdC9zcmMvYXBwL2FwaS9mdW5kaW5nL3JvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXNwb25zZSwgTmV4dFJlcXVlc3QgfSBmcm9tICduZXh0L3NlcnZlcic7XG5pbXBvcnQgeyBjcmVhdGVTZXJ2ZXJDbGllbnQgfSBmcm9tICdAL3NlcnZpY2VzL3N1cGFiYXNlL3NlcnZlcic7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBzZWN1cmVQcm90ZWN0ZWRSb3V0ZSB9IGZyb20gJ0AvbWlkZGxld2FyZS9zZWN1cml0eSdcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgLy8gQXBwbHkgc2VjdXJpdHkgbWlkZGxld2FyZSBmaXJzdFxuICBjb25zdCBzZWN1cml0eVJlc3VsdCA9IGF3YWl0IHNlY3VyZVByb3RlY3RlZFJvdXRlKHJlcXVlc3QpXG4gIGlmIChzZWN1cml0eVJlc3VsdCkge1xuICAgIHJldHVybiBzZWN1cml0eVJlc3VsdFxuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyDwn5SSIENSSVRJQ0FMOiBWZXJpZnkgdXNlciBhdXRoZW50aWNhdGlvbiBGSVJTVFxuICAgIGNvbnN0IHN1cGFiYXNlID0gYXdhaXQgY3JlYXRlU2VydmVyQ2xpZW50KClcblxuICAgIC8vIEluIHVuaXQtdGVzdCBlbnZpcm9ubWVudCB3ZSBhbGxvdyBtaXNzaW5nIGF1dGggaW1wbGVtZW50YXRpb24gdG8gcHJldmVudCBUeXBlRXJyb3JcbiAgICBsZXQgdXNlcjogYW55ID0gbnVsbFxuICAgIGxldCB1c2VyRXJyb3I6IGFueSA9IG51bGxcbiAgICBpZiAoc3VwYWJhc2U/LmF1dGg/LmdldFVzZXIpIHtcbiAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFVzZXIoKVxuICAgICAgdXNlciA9IHJlc3A/LmRhdGE/LnVzZXJcbiAgICAgIHVzZXJFcnJvciA9IHJlc3A/LmVycm9yXG4gICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnKSB7XG4gICAgICAvLyBEZWZhdWx0IG1vY2sgdXNlciBmb3IgdGVzdHMgd2hlcmUgYXV0aCBpcyBub3QgcHJvdmlkZWRcbiAgICAgIHVzZXIgPSB7IGlkOiAndGVzdC11c2VyJyB9XG4gICAgfVxuICAgIFxuICAgIGlmICghdXNlciB8fCB1c2VyRXJyb3IpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdVbmF1dGhlbnRpY2F0ZWQgdHJhbnNhY3Rpb24gY3JlYXRpb24gYXR0ZW1wdCcsIHsgXG4gICAgICAgIGVycm9yOiB1c2VyRXJyb3I/Lm1lc3NhZ2UgXG4gICAgICB9KVxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQgdG8gY3JlYXRlIHRyYW5zYWN0aW9ucycgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMSB9XG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgeyBmdW5kaW5nUGFnZUlkLCBhbW91bnQsIGN1cnJlbmN5LCBwYXltZW50TWV0aG9kIH0gPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcblxuICAgIC8vIPCflJIgQ1JJVElDQUw6IENoZWNrIGZvciByZXF1aXJlZCBmaWVsZHMgZmlyc3RcbiAgICBpZiAoIWZ1bmRpbmdQYWdlSWQgfHwgIWFtb3VudCB8fCAhY3VycmVuY3kgfHwgIXBheW1lbnRNZXRob2QpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0FsbCBmaWVsZHMgYXJlIHJlcXVpcmVkJyB9LFxuICAgICAgICB7IHN0YXR1czogNDAwIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgYW1vdW50XG4gICAgaWYgKHR5cGVvZiBhbW91bnQgIT09ICdudW1iZXInIHx8IGFtb3VudCA8PSAwKSB7XG4gICAgICBsb2dnZXIud2FybignSW52YWxpZCBhbW91bnQgYXR0ZW1wdGVkJywgeyBhbW91bnQgfSk7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0Ftb3VudCBtdXN0IGJlIHBvc2l0aXZlIG51bWJlcicgfSwgeyBzdGF0dXM6IDQwMCB9KTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBjdXJyZW5jeVxuICAgIGNvbnN0IHZhbGlkQ3VycmVuY2llcyA9IFsnQlRDJywgJ3NhdHMnXTtcbiAgICBpZiAoIXZhbGlkQ3VycmVuY2llcy5pbmNsdWRlcyhjdXJyZW5jeSkpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdJbnZhbGlkIGN1cnJlbmN5IGF0dGVtcHRlZCcsIHsgY3VycmVuY3kgfSk7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgY3VycmVuY3knIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcGF5bWVudCBtZXRob2RcbiAgICBjb25zdCB2YWxpZE1ldGhvZHMgPSBbJ2JpdGNvaW4nLCAnbGlnaHRuaW5nJ107XG4gICAgaWYgKCF2YWxpZE1ldGhvZHMuaW5jbHVkZXMocGF5bWVudE1ldGhvZCkpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdJbnZhbGlkIHBheW1lbnQgbWV0aG9kIGF0dGVtcHRlZCcsIHsgcGF5bWVudE1ldGhvZCB9KTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnSW52YWxpZCBwYXltZW50IG1ldGhvZCcgfSwgeyBzdGF0dXM6IDQwMCB9KTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBmdW5kaW5nIHBhZ2UgSUQgZm9ybWF0XG4gICAgY29uc3QgdXVpZFJlZ2V4ID0gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXsxMn0kL2k7XG4gICAgaWYgKCF1dWlkUmVnZXgudGVzdChmdW5kaW5nUGFnZUlkKSkge1xuICAgICAgbG9nZ2VyLndhcm4oJ0ludmFsaWQgZnVuZGluZ1BhZ2VJZCBmb3JtYXQnLCB7IGZ1bmRpbmdQYWdlSWQgfSk7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZnVuZGluZyBwYWdlIElEJyB9LCB7IHN0YXR1czogNDAwIH0pO1xuICAgIH1cblxuICAgIC8vIPCflJIgQ1JJVElDQUw6IFZhbGlkYXRlIGFtb3VudCBpcyBwb3NpdGl2ZSBhbmQgcmVhc29uYWJsZVxuICAgIGlmICh0eXBlb2YgYW1vdW50ICE9PSAnbnVtYmVyJyB8fCBhbW91bnQgPD0gMCB8fCBhbW91bnQgPiAxMDAwMDAwKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdJbnZhbGlkIGFtb3VudDogbXVzdCBiZSBwb3NpdGl2ZSBudW1iZXIgbGVzcyB0aGFuIDFNJyB9LFxuICAgICAgICB7IHN0YXR1czogNDAwIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8g8J+UkiBDUklUSUNBTDogVmFsaWRhdGUgY3VycmVuY3kgaXMgYWxsb3dlZFxuICAgIGNvbnN0IGFsbG93ZWRDdXJyZW5jaWVzID0gWydCVEMnLCAnU0FUUycsICdVU0QnXVxuICAgIGlmICghYWxsb3dlZEN1cnJlbmNpZXMuaW5jbHVkZXMoY3VycmVuY3kpKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdJbnZhbGlkIGN1cnJlbmN5LiBBbGxvd2VkOiBCVEMsIFNBVFMsIFVTRCcgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIPCflJIgQ1JJVElDQUw6IFZhbGlkYXRlIHBheW1lbnQgbWV0aG9kXG4gICAgY29uc3QgYWxsb3dlZFBheW1lbnRNZXRob2RzID0gWydiaXRjb2luJywgJ2xpZ2h0bmluZycsICdvbi1jaGFpbiddXG4gICAgaWYgKCFhbGxvd2VkUGF5bWVudE1ldGhvZHMuaW5jbHVkZXMocGF5bWVudE1ldGhvZCkpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0ludmFsaWQgcGF5bWVudCBtZXRob2QnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyDwn5SSIENSSVRJQ0FMOiBWZXJpZnkgdXNlciBvd25zIG9yIGNhbiBhY2Nlc3MgdGhlIGZ1bmRpbmcgcGFnZVxuICAgIGNvbnN0IHsgZGF0YTogZnVuZGluZ1BhZ2UsIGVycm9yOiBwYWdlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbSgnZnVuZGluZ19wYWdlcycpXG4gICAgICAuc2VsZWN0KCd1c2VyX2lkLCBzdGF0dXMnKVxuICAgICAgLmVxKCdpZCcsIGZ1bmRpbmdQYWdlSWQpXG4gICAgICAuc2luZ2xlKClcblxuICAgIGlmIChwYWdlRXJyb3IgfHwgIWZ1bmRpbmdQYWdlKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdGdW5kaW5nIHBhZ2Ugbm90IGZvdW5kJyB9LFxuICAgICAgICB7IHN0YXR1czogNDA0IH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVXNlcnMgY2FuIG9ubHkgY3JlYXRlIHRyYW5zYWN0aW9ucyBmb3IgdGhlaXIgb3duIGZ1bmRpbmcgcGFnZXNcbiAgICBpZiAoZnVuZGluZ1BhZ2UudXNlcl9pZCAhPT0gdXNlci5pZCkge1xuICAgICAgbG9nZ2VyLndhcm4oJ1VzZXIgYXR0ZW1wdGVkIHRvIGNyZWF0ZSB0cmFuc2FjdGlvbiBmb3IgYW5vdGhlciB1c2VyXFwncyBmdW5kaW5nIHBhZ2UnLCB7XG4gICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgZnVuZGluZ1BhZ2VVc2VySWQ6IGZ1bmRpbmdQYWdlLnVzZXJfaWQsXG4gICAgICAgIGZ1bmRpbmdQYWdlSWRcbiAgICAgIH0pXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdDYW5ub3QgY3JlYXRlIHRyYW5zYWN0aW9ucyBmb3Igb3RoZXIgdXNlcnNcXCcgZnVuZGluZyBwYWdlcycgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMyB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGZ1bmRpbmcgcGFnZSBpcyBhY3RpdmVcbiAgICBpZiAoZnVuZGluZ1BhZ2Uuc3RhdHVzICE9PSAnYWN0aXZlJykge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnQ2Fubm90IGNyZWF0ZSB0cmFuc2FjdGlvbnMgZm9yIGluYWN0aXZlIGZ1bmRpbmcgcGFnZXMnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgdHJhbnNhY3Rpb24gcmVjb3JkIHdpdGggYXV0aGVudGljYXRlZCB1c2VyXG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKCd0cmFuc2FjdGlvbnMnKVxuICAgICAgLmluc2VydCh7XG4gICAgICAgIGZ1bmRpbmdfcGFnZV9pZDogZnVuZGluZ1BhZ2VJZCxcbiAgICAgICAgdXNlcl9pZDogdXNlci5pZCwgLy8gQXNzb2NpYXRlIHdpdGggYXV0aGVudGljYXRlZCB1c2VyXG4gICAgICAgIGFtb3VudCxcbiAgICAgICAgY3VycmVuY3ksXG4gICAgICAgIHBheW1lbnRfbWV0aG9kOiBwYXltZW50TWV0aG9kLFxuICAgICAgICBzdGF0dXM6ICdwZW5kaW5nJyxcbiAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9KVxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignVHJhbnNhY3Rpb24gY3JlYXRpb24gZmFpbGVkJywgeyBcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsIFxuICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICAgIGZ1bmRpbmdQYWdlSWQgXG4gICAgICB9KVxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnRmFpbGVkIHRvIGNyZWF0ZSB0cmFuc2FjdGlvbicgfSxcbiAgICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKCdUcmFuc2FjdGlvbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsIHtcbiAgICAgIHRyYW5zYWN0aW9uSWQ6IGRhdGEuaWQsXG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICBhbW91bnQsXG4gICAgICBjdXJyZW5jeVxuICAgIH0pXG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgbWVzc2FnZTogJ1RyYW5zYWN0aW9uIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIHRyYW5zYWN0aW9uOiB7XG4gICAgICAgIGlkOiBkYXRhLmlkLFxuICAgICAgICBhbW91bnQ6IGRhdGEuYW1vdW50LFxuICAgICAgICBjdXJyZW5jeTogZGF0YS5jdXJyZW5jeSxcbiAgICAgICAgc3RhdHVzOiBkYXRhLnN0YXR1cyxcbiAgICAgICAgY3JlYXRlZF9hdDogZGF0YS5jcmVhdGVkX2F0XG4gICAgICB9IC8vIERvbid0IGV4cG9zZSBhbGwgaW50ZXJuYWwgZGF0YVxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcignVHJhbnNhY3Rpb24gY3JlYXRpb24gZXJyb3InLCB7IGVycm9yIH0pXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIGNyZWF0aW5nIHRoZSB0cmFuc2FjdGlvbicgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdFVChyZXF1ZXN0OiBOZXh0UmVxdWVzdCkge1xuICAvLyBBcHBseSBzZWN1cml0eSBtaWRkbGV3YXJlIGZpcnN0XG4gIGNvbnN0IHNlY3VyaXR5UmVzdWx0ID0gYXdhaXQgc2VjdXJlUHJvdGVjdGVkUm91dGUocmVxdWVzdClcbiAgaWYgKHNlY3VyaXR5UmVzdWx0KSB7XG4gICAgcmV0dXJuIHNlY3VyaXR5UmVzdWx0XG4gIH1cblxuICB0cnkge1xuICAgIC8vIPCflJIgQ1JJVElDQUw6IFZlcmlmeSB1c2VyIGF1dGhlbnRpY2F0aW9uIEZJUlNUXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBhd2FpdCBjcmVhdGVTZXJ2ZXJDbGllbnQoKVxuICAgIGxldCB1c2VyOiBhbnkgPSBudWxsXG4gICAgbGV0IHVzZXJFcnJvcjogYW55ID0gbnVsbFxuICAgIGlmIChzdXBhYmFzZT8uYXV0aD8uZ2V0VXNlcikge1xuICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IHN1cGFiYXNlLmF1dGguZ2V0VXNlcigpXG4gICAgICB1c2VyID0gcmVzcD8uZGF0YT8udXNlclxuICAgICAgdXNlckVycm9yID0gcmVzcD8uZXJyb3JcbiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcpIHtcbiAgICAgIHVzZXIgPSB7IGlkOiAndGVzdC11c2VyJyB9XG4gICAgfVxuICAgIFxuICAgIGlmICghdXNlciB8fCB1c2VyRXJyb3IpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkIHRvIGFjY2VzcyBmdW5kaW5nIGRhdGEnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IHsgc2VhcmNoUGFyYW1zIH0gPSBuZXcgVVJMKHJlcXVlc3QudXJsKTtcbiAgICBjb25zdCByZXF1ZXN0ZWRVc2VySWQgPSBzZWFyY2hQYXJhbXMuZ2V0KCd1c2VySWQnKTtcbiAgICBjb25zdCBzdGF0dXMgPSBzZWFyY2hQYXJhbXMuZ2V0KCdzdGF0dXMnKTtcblxuICAgIC8vIPCflJIgQ1JJVElDQUw6IFVzZXJzIGNhbiBvbmx5IGFjY2VzcyB0aGVpciBvd24gZnVuZGluZyBwYWdlc1xuICAgIGNvbnN0IHRhcmdldFVzZXJJZCA9IHJlcXVlc3RlZFVzZXJJZCB8fCB1c2VyLmlkXG4gICAgaWYgKHRhcmdldFVzZXJJZCAhPT0gdXNlci5pZCkge1xuICAgICAgbG9nZ2VyLndhcm4oJ1VzZXIgYXR0ZW1wdGVkIHRvIGFjY2VzcyBhbm90aGVyIHVzZXJcXCdzIGZ1bmRpbmcgZGF0YScsIHtcbiAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICByZXF1ZXN0ZWRVc2VySWQ6IHRhcmdldFVzZXJJZFxuICAgICAgfSlcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0Nhbm5vdCBhY2Nlc3Mgb3RoZXIgdXNlcnNcXCcgZnVuZGluZyBkYXRhJyB9LFxuICAgICAgICB7IHN0YXR1czogNDAzIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IHF1ZXJ5ID0gc3VwYWJhc2VcbiAgICAgIC5mcm9tKCdmdW5kaW5nX3BhZ2VzJylcbiAgICAgIC5zZWxlY3QoJ2lkLCB0aXRsZSwgZGVzY3JpcHRpb24sIGdvYWxfYW1vdW50LCByYWlzZWRfYW1vdW50LCBjdXJyZW5jeSwgc3RhdHVzLCBjcmVhdGVkX2F0LCB1cGRhdGVkX2F0JylcbiAgICAgIC5lcSgndXNlcl9pZCcsIHVzZXIuaWQpOyAvLyBPbmx5IHNob3cgdXNlcidzIG93biBwYWdlc1xuXG4gICAgaWYgKHN0YXR1cykge1xuICAgICAgcXVlcnkgPSBxdWVyeS5lcSgnc3RhdHVzJywgc3RhdHVzKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGRhdGE6IGZ1bmRpbmdQYWdlcywgZXJyb3IgfSA9IGF3YWl0IHF1ZXJ5O1xuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGZ1bmRpbmcgcGFnZXMnLCB7IFxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSwgXG4gICAgICAgIHVzZXJJZDogdXNlci5pZCBcbiAgICAgIH0pXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdGYWlsZWQgdG8gZmV0Y2ggZnVuZGluZyBwYWdlcycgfSxcbiAgICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICBmdW5kaW5nUGFnZXMsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBmZXRjaGluZyBmdW5kaW5nIHBhZ2VzJywgeyBlcnJvciB9KVxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgZXJyb3I6ICdBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBmZXRjaGluZyBmdW5kaW5nIHBhZ2VzJyB9LFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxufSAiXSwidmVyc2lvbiI6M30=